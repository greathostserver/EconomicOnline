<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>داشبور زنده بازارها</title>
  <meta name="description" content="نمایش زنده بازار کریپتو از Binance، ارزهای جهان، و کامودیتی‌ها. چندزبانه، جستجو و مرتب‌سازی. آماده برای GitHub Pages." />
  <link rel="preconnect" href="https://api.binance.com">
  <link rel="preconnect" href="https://api.frankfurter.app">
  <style>
    :root {
      --bg: #0f1115; --panel: #151823; --text: #e7edf2; --muted: #9aa7b0;
      --accent: #4cc9f0; --up: #1db954; --down: #ff3b30; --border: #222636;
      --card: #12141c; --shadow: 0 8px 18px rgba(0,0,0,0.35);
      --table-row: #1a1f2b; --table-row-alt: #151a24;
    }
    [data-theme="light"] {
      --bg: #f6f7fb; --panel: #ffffff; --text: #1a2230; --muted: #5c6b7c;
      --accent: #1f7ae0; --up: #1ea865; --down: #c0392b; --border: #dfe4ea;
      --card: #ffffff; --shadow: 0 8px 18px rgba(0,0,0,0.08);
      --table-row: #ffffff; --table-row-alt: #f3f6fa;
    }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Naskh Arabic", "Tahoma", Arial;
    }
    header { position: sticky; top: 0; z-index: 50; backdrop-filter: saturate(1.2) blur(6px);
      background: color-mix(in oklab, var(--bg) 80%, transparent 20%);
      border-bottom: 1px solid var(--border); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 14px; }
    .toolbar { display:flex; align-items:center; gap:10px; flex-wrap: wrap; }
    .toolbar select, .toolbar button, .toolbar input {
      background: var(--panel); color: var(--text); border: 1px solid var(--border);
      border-radius: 10px; padding: 8px 10px; cursor: pointer;
    }
    .row { display: grid; gap: 14px; grid-template-columns: 1fr; }
    @media (min-width: 900px) { .row { grid-template-columns: 2fr 1fr; } }
    .card { background: var(--card); border: 1px solid var(--border);
      border-radius: 12px; box-shadow: var(--shadow); overflow: hidden; }
    .card h3 { margin: 0; padding: 10px 14px; border-bottom: 1px solid var(--border); font-size: 16px; }
    .card .content { padding: 10px 14px; }
    .status { font-size: 13px; color: var(--muted); margin-top: 6px; }
    .badge { font-size: 13px; color: var(--muted); }
    .footer { padding: 16px; text-align: center; color: var(--muted); }

    /* Table */
    .table-wrap { overflow: auto; border: 1px solid var(--border); border-radius: 10px; }
    table { width: 100%; border-collapse: collapse; min-width: 700px; }
    thead th {
      background: var(--panel); color: var(--text); border-bottom: 1px solid var(--border);
      padding: 10px; font-weight: 600; text-align: left; cursor: pointer; position: sticky; top: 0;
    }
    tbody td { padding: 10px; border-bottom: 1px solid var(--border); }
    tbody tr:nth-child(odd) { background: var(--table-row); }
    tbody tr:nth-child(even) { background: var(--table-row-alt); }
    .delta-up { color: var(--up); font-weight: 600; }
    .delta-down { color: var(--down); font-weight: 600; }

    /* Iframes grid */
    .grid { display:grid; gap: 10px; grid-template-columns: 1fr; }
    @media (min-width: 760px) { .grid { grid-template-columns: repeat(2, 1fr); } }
    .iframe-box { border: 1px solid var(--border); border-radius: 10px; overflow: hidden; background: var(--panel); }
    .iframe-box iframe { width: 100%; height: 280px; border: 0; }
  </style>
</head>
<body data-theme="dark">
  <header>
    <div class="wrap toolbar">
      <strong id="title">داشبور زنده بازارها</strong>
      <span class="badge" id="badge">بدون‌سرور • مناسب GitHub Pages</span>
      <div style="flex:1"></div>
      <input id="cryptoSearch" type="text" placeholder="جستجو جفت ارز…" aria-label="Search pair" />
      <select id="quoteSelect" aria-label="Quote">
        <option value="USDT">USDT</option>
        <option value="BUSD">BUSD</option>
        <option value="USDC">USDC</option>
        <option value="BTC">BTC</option>
      </select>
      <select id="langSelect" aria-label="Language">
        <option value="fa">فارسی</option>
        <option value="ar">العربية</option>
        <option value="en">English</option>
        <option value="ru">Русский</option>
      </select>
      <button id="toggleTheme">تم روشن/تاریک</button>
      <button id="refreshAll">به‌روزرسانی</button>
    </div>
  </header>

  <main class="wrap">
    <div class="row">
      <section class="card" id="cryptoCard">
        <h3 id="cryptoTitle">کریپتو از Binance (24h)</h3>
        <div class="content">
          <div class="status" id="cryptoStatus">در حال بارگذاری از Binance…</div>
          <div class="table-wrap">
            <table id="cryptoTable">
              <thead>
                <tr>
                  <th data-key="symbol" id="thPair">جفت</th>
                  <th data-key="lastPriceNum" id="thPrice">قیمت</th>
                  <th data-key="priceChangePercentNum" id="thChange">تغییر 24h</th>
                  <th data-key="quoteVolumeNum" id="thVol">حجم 24h (Quote)</th>
                  <th data-key="count" id="thTrades">تعداد معاملات</th>
                </tr>
              </thead>
              <tbody id="cryptoBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="card" id="forexCard">
        <h3 id="forexTitle">ارزهای جهان (Forex)</h3>
        <div class="content">
          <div class="status" id="forexStatus">در حال دریافت از Frankfurter…</div>
          <div class="table-wrap">
            <table id="forexTable">
              <thead>
                <tr>
                  <th id="fxPairHdr">جفت ارز</th>
                  <th id="fxRateHdr">نرخ</th>
                </tr>
              </thead>
              <tbody id="forexBody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>

    <section class="card" id="commoditiesCard" style="margin-top:12px;">
      <h3 id="commoditiesTitle">طلا و کامودیتی‌ها</h3>
      <div class="content grid">
        <div class="iframe-box">
          <iframe src="https://s.tradingview.com/widgetembed/?frameElementId=tvx&symbol=TVC%3AGOLD&interval=60&hidesidetoolbar=1&symboledit=1&saveimage=0&toolbarbg=fff&studies=[]&theme=dark&style=1&timezone=Etc%2FUTC&withdateranges=1&hideideas=1&hide_top_toolbar=1&hidetimescale=1" title="Gold"></iframe>
        </div>
        <div class="iframe-box">
          <iframe src="https://s.tradingview.com/widgetembed/?frameElementId=tvx&symbol=TVC%3AUSOIL&interval=60&hidesidetoolbar=1&symboledit=1&saveimage=0&toolbarbg=fff&studies=[]&theme=dark&style=1&timezone=Etc%2FUTC&withdateranges=1&hideideas=1&hide_top_toolbar=1&hidetimescale=1" title="Oil"></iframe>
        </div>
      </div>
    </section>

    <div class="footer" id="footerText">
      ساخته‌شده برای اجرا روی GitHub Pages • بدون‌سرور • به‌روزرسانی سمت‌کاربر
    </div>
  </main>

  <script>
    // ===== i18n =====
    const i18n = {
      fa: {
        dir:'rtl', locale:'fa-IR',
        title:'داشبور زنده بازارها', badge:'بدون‌سرور • مناسب GitHub Pages',
        cryptoTitle:'کریپتو از Binance (24h)', cryptoStatus:'در حال بارگذاری از Binance…',
        thPair:'جفت', thPrice:'قیمت', thChange:'تغییر 24h', thVol:'حجم 24h (Quote)', thTrades:'تعداد معاملات',
        forexTitle:'ارزهای جهان (Forex)', forexStatus:'در حال دریافت از Frankfurter…',
        fxPairHdr:'جفت ارز', fxRateHdr:'نرخ',
        commoditiesTitle:'طلا و کامودیتی‌ها',
        lastUpdate:'آخرین بروزرسانی', themeBtn:'تم روشن/تاریک', refreshBtn:'به‌روزرسانی',
        searchPlaceholder:'جستجو جفت ارز…'
      },
      ar: {
        dir:'rtl', locale:'ar-SA',
        title:'لوحة الأسواق الحية', badge:'بدون خادم • مناسب لـ GitHub Pages',
        cryptoTitle:'كريبتو من Binance (24س)', cryptoStatus:'جارٍ التحميل من Binance…',
        thPair:'الزوج', thPrice:'السعر', thChange:'تغير 24س', thVol:'حجم 24س (الاقتباس)', thTrades:'عدد الصفقات',
        forexTitle:'عملات العالم (فوركس)', forexStatus:'جارٍ الجلب من Frankfurter…',
        fxPairHdr:'زوج العملة', fxRateHdr:'السعر',
        commoditiesTitle:'الذهب والسلع',
        lastUpdate:'آخر تحديث', themeBtn:'سمة فاتحة/داكنة', refreshBtn:'تحديث',
        searchPlaceholder:'ابحث عن الزوج…'
      },
      en: {
        dir:'ltr', locale:'en-US',
        title:'Live markets dashboard', badge:'Serverless • Built for GitHub Pages',
        cryptoTitle:'Crypto from Binance (24h)', cryptoStatus:'Loading from Binance…',
        thPair:'Pair', thPrice:'Price', thChange:'24h change', thVol:'24h volume (quote)', thTrades:'Trade count',
        forexTitle:'Global currencies (Forex)', forexStatus:'Fetching from Frankfurter…',
        fxPairHdr:'Pair', fxRateHdr:'Rate',
        commoditiesTitle:'Gold and commodities',
        lastUpdate:'Last update', themeBtn:'Light/Dark', refreshBtn:'Refresh',
        searchPlaceholder:'Search pair…'
      },
      ru: {
        dir:'ltr', locale:'ru-RU',
        title:'Панель живых рынков', badge:'Без сервера • Для GitHub Pages',
        cryptoTitle:'Крипто с Binance (24ч)', cryptoStatus:'Загрузка с Binance…',
        thPair:'Пара', thPrice:'Цена', thChange:'Изм. 24ч', thVol:'Объём 24ч (кот.)', thTrades:'Сделки',
        forexTitle:'Мировые валюты (Forex)', forexStatus:'Получение с Frankfurter…',
        fxPairHdr:'Пара', fxRateHdr:'Курс',
        commoditiesTitle:'Золото и сырьё',
        lastUpdate:'Последнее обновление', themeBtn:'Светлая/Тёмная', refreshBtn:'Обновить',
        searchPlaceholder:'Поиск пары…'
      }
    };

    // ===== State =====
    const state = {
      theme: localStorage.getItem('theme') || 'dark',
      lang: localStorage.getItem('lang') || 'fa',
      sortKey: 'quoteVolumeNum',
      sortDir: 'desc',
      quote: localStorage.getItem('quote') || 'USDT',
      cryptoData: [],
      refreshMs: 60000, // 60s
      timers: []
    };
    document.body.setAttribute('data-theme', state.theme);

    // ===== Helpers =====
    function t(key){ const p=i18n[state.lang]; return p[key] || key; }
    function setText(id, val){ const el=document.getElementById(id); if(el) el.textContent=String(val); }
    function formatNum(n, opts){ try{ return Number(n).toLocaleString(i18n[state.lang].locale, opts||{}); }catch{ return n; } }
    function applyLang(){
      const p = i18n[state.lang];
      document.documentElement.dir = p.dir;
      document.documentElement.lang = state.lang;
      setText('title', p.title);
      setText('badge', p.badge);
      setText('cryptoTitle', p.cryptoTitle);
      setText('cryptoStatus', p.cryptoStatus);
      setText('thPair', p.thPair);
      setText('thPrice', p.thPrice);
      setText('thChange', p.thChange);
      setText('thVol', p.thVol);
      setText('thTrades', p.thTrades);
      setText('forexTitle', p.forexTitle);
      setText('forexStatus', p.forexStatus);
      setText('fxPairHdr', p.fxPairHdr);
      setText('fxRateHdr', p.fxRateHdr);
      setText('commoditiesTitle', p.commoditiesTitle);
      document.getElementById('toggleTheme').textContent = p.themeBtn;
      document.getElementById('refreshAll').textContent = p.refreshBtn;
      document.getElementById('cryptoSearch').placeholder = p.searchPlaceholder;
      renderCrypto(); // re-render number formats
    }

    function schedule(){
      state.timers.forEach(clearInterval);
      state.timers = [];
      state.timers.push(setInterval(loadCrypto, state.refreshMs));
      state.timers.push(setInterval(loadForex, state.refreshMs));
    }

    // ===== UI events =====
    document.getElementById('toggleTheme').addEventListener('click', ()=>{
      state.theme = state.theme === 'dark' ? 'light' : 'dark';
      document.body.setAttribute('data-theme', state.theme);
      localStorage.setItem('theme', state.theme);
    });
    const langSelect = document.getElementById('langSelect');
    langSelect.value = state.lang;
    langSelect.addEventListener('change', ()=>{
      state.lang = langSelect.value;
      localStorage.setItem('lang', state.lang);
      applyLang();
    });
    const quoteSelect = document.getElementById('quoteSelect');
    quoteSelect.value = state.quote;
    quoteSelect.addEventListener('change', ()=>{
      state.quote = quoteSelect.value;
      localStorage.setItem('quote', state.quote);
      loadCrypto();
    });
    document.getElementById('refreshAll').addEventListener('click', ()=>{
      loadCrypto();
      loadForex();
    });
    document.getElementById('cryptoSearch').addEventListener('input', renderCrypto);

    // ===== Binance Crypto (24h ticker) =====
    async function loadCrypto(){
      const status = document.getElementById('cryptoStatus');
      const quote = state.quote;
      try {
        setText('cryptoStatus', t('cryptoStatus'));
        // Fetch all 24hr tickers
        const res = await fetch('https://api.binance.com/api/v3/ticker/24hr', {cache:'no-store'});
        if (!res.ok) throw new Error('Binance 24hr error');
        const data = await res.json();
        // Filter by selected quote (e.g., USDT)
        const filtered = data.filter(d => d.symbol.endsWith(quote));
        // Map numeric fields for sorting/formatting
        state.cryptoData = filtered.map(d => ({
          symbol: d.symbol,
          base: d.symbol.slice(0, d.symbol.length - quote.length),
          quote: quote,
          lastPrice: d.lastPrice,
          lastPriceNum: Number(d.lastPrice),
          priceChangePercent: d.priceChangePercent,
          priceChangePercentNum: Number(d.priceChangePercent),
          quoteVolume: d.quoteVolume,
          quoteVolumeNum: Number(d.quoteVolume),
          count: Number(d.count || 0)
        }));
        // Default sort by quote volume desc
        state.sortKey = state.sortKey || 'quoteVolumeNum';
        state.sortDir = state.sortDir || 'desc';
        renderCrypto();
        status.textContent = `${t('lastUpdate')}: ${new Date().toLocaleTimeString(i18n[state.lang].locale)}`;
      } catch (e) {
        status.textContent = state.lang==='en' ? 'Error loading Binance data.' :
                             state.lang==='ru' ? 'Ошибка загрузки данных Binance.' :
                             state.lang==='ar' ? 'خطأ في جلب بيانات Binance.' :
                             'خطا در دریافت داده‌های Binance.';
        console.error(e);
      }
    }

    function renderCrypto(){
      const body = document.getElementById('cryptoBody');
      const q = document.getElementById('cryptoSearch').value.trim().toLowerCase();
      let rows = state.cryptoData.slice();

      // Filter by search query (pair or base)
      if (q) {
        rows = rows.filter(r =>
          r.symbol.toLowerCase().includes(q) ||
          r.base.toLowerCase().includes(q)
        );
      }

      // Sort
      const key = state.sortKey;
      const dir = state.sortDir === 'asc' ? 1 : -1;
      rows.sort((a,b)=>{
        const va = a[key] ?? 0, vb = b[key] ?? 0;
        if (va < vb) return -1 * dir;
        if (va > vb) return 1 * dir;
        return 0;
      });

      // Render top 200 for performance
      const renderRows = rows.slice(0, 200).map(r=>{
        const cls = r.priceChangePercentNum >= 0 ? 'delta-up' : 'delta-down';
        return `
          <tr>
            <td>${escapeHtml(r.base)}/${escapeHtml(r.quote)}</td>
            <td>$${formatNum(r.lastPriceNum, {maximumFractionDigits: 8})}</td>
            <td class="${cls}">${formatNum(r.priceChangePercentNum, {maximumFractionDigits: 2})}%</td>
            <td>$${formatNum(r.quoteVolumeNum)}</td>
            <td>${formatNum(r.count)}</td>
          </tr>
        `;
      }).join('');
      body.innerHTML = renderRows;
    }

    // Sort handlers
    const ths = document.querySelectorAll('#cryptoTable thead th');
    ths.forEach(th=>{
      th.addEventListener('click', ()=>{
        const key = th.getAttribute('data-key');
        if (!key) return;
        if (state.sortKey === key) {
          state.sortDir = state.sortDir === 'asc' ? 'desc' : 'asc';
        } else {
          state.sortKey = key;
          state.sortDir = 'desc';
        }
        renderCrypto();
      });
    });

    // ===== Forex =====
    async function loadForex(){
      const status = document.getElementById('forexStatus');
      const body = document.getElementById('forexBody');
      try {
        setText('forexStatus', t('forexStatus'));
        const pairs = [['USD','EUR'], ['USD','GBP'], ['USD','JPY'], ['EUR','USD'], ['EUR','GBP']];
        const out = [];
        for (const [base, quote] of pairs) {
          const res = await fetch(`https://api.frankfurter.app/latest?from=${base}&to=${quote}`, {cache:'no-store'});
          if (!res.ok) throw new Error('Frankfurter error');
          const data = await res.json();
          const rate = data.rates[quote];
          out.push(`<tr><td>${base}/${quote}</td><td>${formatNum(rate, {maximumFractionDigits: 6})}</td></tr>`);
        }
        body.innerHTML = out.join('');
        status.textContent = `${t('lastUpdate')}: ${new Date().toLocaleTimeString(i18n[state.lang].locale)}`;
      } catch (e) {
        status.textContent = state.lang==='en' ? 'Error loading forex.' :
                             state.lang==='ru' ? 'Ошибка загрузки валют.' :
                             state.lang==='ar' ? 'خطأ في جلب العملات.' :
                             'خطا در دریافت داده‌های ارزها.';
        console.error(e);
      }
    }

    // ===== Security helpers =====
    function escapeHtml(s){
      return String(s).replace(/[&<>"'`=\/]/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'
      }[c] || c));
    }

    // ===== Init =====
    document.addEventListener('DOMContentLoaded', ()=>{
      // Apply lang and theme
      document.body.setAttribute('data-theme', state.theme);
      const langSelect = document.getElementById('langSelect'); langSelect.value = state.lang;
      const quoteSelect = document.getElementById('quoteSelect'); quoteSelect.value = state.quote;
      applyLang();
      // Load data
      loadCrypto();
      loadForex();
      // Auto-refresh
      schedule();
    });
  </script>
</body>
</html>
