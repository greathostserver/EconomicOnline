<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>داشبور زنده بازارها</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <style>
    :root {
      --bg:#0f1115; --panel:#151823; --text:#e7edf2; --muted:#9aa7b0;
      --accent:#4cc9f0; --up:#1db954; --down:#ff3b30; --border:#222636;
      --card:#12141c; --shadow:0 8px 18px rgba(0,0,0,0.35);
      --field-w:220px;
    }
    
    [data-theme="light"] {
      --bg:#f6f7fb; --panel:#fff; --text:#1a2230; --muted:#5c6b7c;
      --accent:#1f7ae0; --up:#1ea865; --down:#c0392b; --border:#dfe4ea;
      --card:#fff; --shadow:0 8px 18px rgba(0,0,0,0.08);
    }

    * {
      box-sizing: border-box;
    }
    
    body {
      margin: 0; 
      background: var(--bg); 
      color: var(--text); 
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Naskh Arabic", Tahoma, Arial;
      font-size: 14px;
      line-height: 1.5;
      overflow-x: hidden;
    }

    /* Header Styles */
    header {
      position: sticky; 
      top: 0; 
      z-index: 50; 
      background: color-mix(in oklab, var(--bg) 85%, transparent 15%); 
      border-bottom: 1px solid var(--border); 
      backdrop-filter: saturate(1.2) blur(6px);
      width: 100%;
    }
    
    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 12px 16px;
      width: 100%;
    }
    
    .toolbar {
      display: flex; 
      align-items: center; 
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .toolbar .spacer {
      flex: 1;
      min-width: 20px;
    }
    
    .toolbar button {
      background: var(--panel); 
      color: var(--text); 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      padding: 8px 12px; 
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    
    .toolbar button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    /* Card Styles */
    .card {
      background: var(--card); 
      border: 1px solid var(--border); 
      border-radius: 12px; 
      box-shadow: var(--shadow); 
      overflow: hidden; 
      margin: 16px 0;
      width: 100%;
    }
    
    .card h3 {
      margin: 0; 
      padding: 14px 16px; 
      border-bottom: 1px solid var(--border); 
      font-size: 16px;
      font-weight: 600;
    }
    
    .card .content {
      padding: 16px;
    }
    
    .status {
      font-size: 13px; 
      color: var(--muted); 
      margin-top: 8px;
    }

    /* Grid System */
    .grid-2 {
      display: grid;
      gap: 12px;
      width: 100%;
    }
    
    .grid-3 {
      display: grid;
      gap: 12px;
      width: 100%;
    }
    
    /* Desktop: 2 columns */
    @media (min-width: 768px) {
      .grid-2 {
        grid-template-columns: 1fr 1fr;
      }
      .grid-3 {
        grid-template-columns: 1fr 1fr 1fr;
      }
    }
    
    /* Mobile: 1 column */
    @media (max-width: 767px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
      .grid-3 {
        grid-template-columns: 1fr;
      }
    }

    /* Info Box */
    .info-box {
      border: 1px solid var(--border); 
      border-radius: 10px; 
      padding: 16px; 
      background: var(--panel);
      width: 100%;
    }
    
    .delta-up {
      color: var(--up); 
      font-weight: 600;
    }
    
    .delta-down {
      color: var(--down); 
      font-weight: 600;
    }
    
    .currency-flag {
      width: 24px;
      height: 16px;
      border-radius: 3px;
      object-fit: cover;
      border: 1px solid var(--border);
    }
    
    .currency-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
    }
    
    .currency-item .name {
      font-weight: 600;
      flex: 1;
    }
    
    .currency-item .rate {
      font-family: monospace;
      font-weight: 600;
    }

    /* Form Fields */
    .field {
      display: inline-block; 
      width: 100%;
      max-width: var(--field-w);
    }
    
    .choices {
      width: 100%;
      max-width: var(--field-w);
    }
    
    .choices__inner {
      background: var(--panel); 
      border: 1px solid var(--border); 
      border-radius: 10px; 
      color: var(--text); 
      padding: 10px 12px;
      font-size: 14px;
      min-height: 42px;
    }
    
    .choices__list--dropdown {
      background: #fff; 
      border: 1px solid var(--border); 
      border-radius: 10px; 
      box-shadow: var(--shadow);
      z-index: 100;
    }

    /* Choice Items with Icons */
    .choice-with-icon {
      display: flex; 
      align-items: center; 
      gap: 8px; 
      padding: 8px 10px;
    }
    
    .choice-with-icon img {
      width: 20px; 
      height: 20px; 
      border-radius: 50%; 
      object-fit: contain;
    }
    
    .choice-with-icon .label {
      color: #000 !important; 
      font-weight: 600;
      font-size: 14px;
    }
    
    .choices__list--dropdown .choices__item--selectable.is-highlighted {
      background: var(--accent);
    }
    
    .choices__list--dropdown .choices__item--selectable.is-highlighted .label {
      color: #fff !important;
    }

    /* Selected Item */
    .selected-with-icon {
      display: inline-flex; 
      align-items: center; 
      gap: 8px;
    }
    
    .selected-with-icon img {
      width: 18px; 
      height: 18px; 
      border-radius: 50%; 
      object-fit: contain;
    }
    
    .selected-with-icon .label {
      color: var(--text); 
      font-weight: 600;
      font-size: 14px;
    }

    /* Quote Select Specific Styles */
    #quoteSelect + .choices .choices__list--dropdown .choices__item span,
    #quoteSelect + .choices .choices__list--dropdown .choice-with-icon .label {
      color: #1a2230 !important; 
      font-weight: 600;
    }

    /* Coin Name */
    .coin-name {
      color: #ffd166; 
      font-weight: 700; 
      letter-spacing: 0.2px;
      font-size: 16px;
    }
    
    [data-theme="light"] .coin-name {
      color: #1a2230;
    }

    /* Dropdown Dark Theme */
    body[data-theme="dark"] .choices__list--dropdown {
      background-color: var(--panel) !important;
      border-color: var(--border) !important;
    }

    body[data-theme="dark"] .choices__list--dropdown .choices__item {
      color: var(--text) !important;
      font-size: 14px;
    }

    body[data-theme="dark"] .choices__list--dropdown .choice-with-icon .label {
      color: var(--text) !important;
      font-size: 14px;
    }

    body[data-theme="light"] .choices__list--dropdown .choices__item {
      color: #1a2230 !important;
      font-size: 14px;
    }

    .choices__list--dropdown .choices__item--selectable.is-highlighted {
      background-color: var(--accent) !important;
      color: white !important;
    }

    body[data-theme="light"] #quoteSelect + .choices .choices__list--dropdown .choices__item {
      color: #1a2230 !important;
    }

    body[data-theme="dark"] #quoteSelect + .choices .choices__list--dropdown .choices__item span,
    body[data-theme="dark"] #quoteSelect + .choices .choices__list--dropdown .choice-with-icon .label {
      color: var(--text) !important;
    }
    
    /* Data Display */
    #pairName, #pairPrice, #pairChange, #pairVolume, #pairTrades {
      font-size: 14px;
      margin: 6px 0;
      line-height: 1.4;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 500;
    }
    
    /* Loading Spinner */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--muted);
      border-radius: 50%;
      border-top-color: var(--accent);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Mobile Responsive Adjustments */
    @media (max-width: 767px) {
      .wrap {
        padding: 10px 12px;
      }
      
      .toolbar {
        gap: 8px;
      }
      
      .toolbar button {
        padding: 6px 10px;
        font-size: 13px;
      }
      
      #title {
        font-size: 16px;
      }
      
      .card h3 {
        padding: 12px 14px;
        font-size: 15px;
      }
      
      .card .content {
        padding: 12px;
      }
      
      .info-box {
        padding: 12px;
      }
      
      .choices__inner {
        padding: 8px 10px;
        min-height: 38px;
      }
      
      .field {
        max-width: 100%;
      }
      
      .choices {
        max-width: 100%;
      }
    }
    
    /* Tablet Responsive Adjustments */
    @media (min-width: 768px) and (max-width: 1024px) {
      .wrap {
        padding: 14px 20px;
        max-width: 100%;
      }
      
      .field {
        max-width: 200px;
      }
      
      .choices {
        max-width: 200px;
      }
    }
    
    /* Small Mobile (iPhone SE size) */
    @media (max-width: 375px) {
      .toolbar {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .toolbar .spacer {
        display: none;
      }
      
      .toolbar button, .toolbar select {
        width: 100%;
        max-width: none;
      }
      
      #badge {
        font-size: 11px;
      }
    }
  </style>
</head>
<body data-theme="dark">
  <header>
    <div class="wrap toolbar">
      <strong id="title">داشبور زنده بازارها</strong>
      <span class="status" id="badge">بدون‌سرور • مناسب GitHub Pages</span>
      <div class="spacer"></div>
      <select id="langSelect" class="field">
        <option value="fa">فارسی</option>
        <option value="en">English</option>
      </select>
      <button id="toggleTheme">تم روشن/تاریک</button>
      <button id="refreshAll">به‌روزرسانی</button>
    </div>
  </header>

  <main class="wrap">
    <!-- کریپتو -->
    <section class="card" id="cryptoCard">
      <h3 id="cryptoTitle">کریپتو از Binance (24h)</h3>
      <div class="content">
        <div class="status" id="cryptoStatus">در حال دریافت…</div>

        <div class="grid-2" style="margin-top:12px;">
          <div class="info-box">
            <label id="quoteLabel" for="quoteSelect">انتخاب ارز مبنا (Quote):</label>
            <select id="quoteSelect" class="field">
              <option value="USDT">USDT</option>
              <option value="BUSD">BUSD</option>
              <option value="USDC">USDC</option>
              <option value="BTC">BTC</option>
            </select>
          </div>
          <div class="info-box">
            <label id="pairLabel" for="pairSelect">انتخاب جفت‌ارز:</label>
            <select id="pairSelect" class="field"><option value="">— هیچ‌کدام —</option></select>
            <div class="status" id="pairHint">USDT/USDC/BUSD توصیه‌شده</div>
          </div>
        </div>

        <div class="grid-2" style="margin-top:12px;">
          <div class="info-box">
            <strong id="pairName">—</strong>
            <div id="pairPrice">قیمت: —</div>
            <div id="pairChange">تغییر 24h: —</div>
          </div>
          <div class="info-box">
            <div id="pairVolume">حجم 24h: —</div>
            <div id="pairTrades">تعداد معاملات: —</div>
            <div class="status" id="cryptoUpdated">—</div>
          </div>
        </div>
      </div>
    </section>

    <!-- ارزهای کشورهای دنیا -->
    <section class="card" id="forexCard">
      <h3>نرخ ارز جهانی (به دلار آمریکا)</h3>
      <div class="content">
        <div class="status" id="forexStatus">در حال دریافت نرخ ارزها…</div>
        
        <div class="info-box" style="margin-top:12px;">
          <label for="forexBaseSelect">انتخاب ارز پایه:</label>
          <select id="forexBaseSelect" class="field">
            <option value="USD">دلار آمریکا (USD)</option>
            <option value="EUR">یورو اروپا (EUR)</option>
            <option value="GBP">پوند انگلیس (GBP)</option>
            <option value="IRR">ریال ایران (IRR)</option>
            <option value="TRY">لیر ترکیه (TRY)</option>
            <option value="AED">درهم امارات (AED)</option>
          </select>
          <div class="status" style="margin-top:8px;">نرخ ارزها نسبت به ارز پایه محاسبه می‌شود</div>
        </div>

        <div class="grid-3" style="margin-top:16px;">
          <div class="info-box">
            <div class="currency-item">
              <img src="https://flagcdn.com/w20/eu.png" class="currency-flag" alt="EU">
              <span class="name">یورو اروپا</span>
              <span class="rate" id="eurRate">—</span>
            </div>
            <div id="eurToIrr" class="status" style="margin-top:4px;">—</div>
          </div>
          
          <div class="info-box">
            <div class="currency-item">
              <img src="https://flagcdn.com/w20/gb.png" class="currency-flag" alt="UK">
              <span class="name">پوند انگلیس</span>
              <span class="rate" id="gbpRate">—</span>
            </div>
            <div id="gbpToIrr" class="status" style="margin-top:4px;">—</div>
          </div>
          
          <div class="info-box">
            <div class="currency-item">
              <img src="https://flagcdn.com/w20/ae.png" class="currency-flag" alt="UAE">
              <span class="name">درهم امارات</span>
              <span class="rate" id="aedRate">—</span>
            </div>
            <div id="aedToIrr" class="status" style="margin-top:4px;">—</div>
          </div>
          
          <div class="info-box">
            <div class="currency-item">
              <img src="https://flagcdn.com/w20/tr.png" class="currency-flag" alt="Turkey">
              <span class="name">لیر ترکیه</span>
              <span class="rate" id="tryRate">—</span>
            </div>
            <div id="tryToIrr" class="status" style="margin-top:4px;">—</div>
          </div>
          
          <div class="info-box">
            <div class="currency-item">
              <img src="https://flagcdn.com/w20/cn.png" class="currency-flag" alt="China">
              <span class="name">یوان چین</span>
              <span class="rate" id="cnyRate">—</span>
            </div>
            <div id="cnyToIrr" class="status" style="margin-top:4px;">—</div>
          </div>
          
          <div class="info-box">
            <div class="currency-item">
              <img src="https://flagcdn.com/w20/jp.png" class="currency-flag" alt="Japan">
              <span class="name">ین ژاپن</span>
              <span class="rate" id="jpyRate">—</span>
            </div>
            <div id="jpyToIrr" class="status" style="margin-top:4px;">—</div>
          </div>
        </div>
        
        <div class="status" id="forexUpdated" style="margin-top:12px;">—</div>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script>
    const state = { 
      quote: 'USDT', 
      binanceAll: [], 
      pairChoices: null, 
      quoteChoices: null, 
      usdToIrr: 0,
      forexRates: {},
      forexBase: 'USD',
      forexChoices: null
    };

    function iconUrl(base){ return `https://cryptoicon-api.vercel.app/api/icon/${base.toLowerCase()}`; }
    
    function formatNum(n, opts){ 
      try{ 
        return Number(n).toLocaleString('fa-IR', opts || {}); 
      } catch{ 
        return n; 
      } 
    }
    
    function formatCurrency(n, currency = 'USD') {
      try {
        return Number(n).toLocaleString('fa-IR', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 4
        });
      } catch {
        return n;
      }
    }

    async function loadUsdToIrr(){
      try{
        const res = await fetch('https://api.exchangerate.host/latest?base=USD&symbols=IRR', {cache:'no-store'});
        const data = await res.json();
        state.usdToIrr = Number(data.rates?.IRR || 0);
        // بعد از دریافت نرخ دلار، نرخ ارزها را هم بروزرسانی می‌کنیم
        if (Object.keys(state.forexRates).length > 0) {
          updateForexDisplay();
        }
      }catch(e){ 
        console.error('Error loading USD to IRR:', e);
        state.usdToIrr = 0; 
      }
    }

    async function loadBinance(){
      document.getElementById('cryptoStatus').textContent = 'در حال دریافت از Binance…';
      try {
        const res = await fetch('https://api.binance.com/api/v3/ticker/24hr', {cache:'no-store'});
        if (!res.ok) { 
          document.getElementById('cryptoStatus').textContent = 'خطا در دریافت داده‌های Binance'; 
          return; 
        }
        state.binanceAll = await res.json();
        populatePairs();
        document.getElementById('cryptoUpdated').textContent = `آخرین بروزرسانی: ${new Date().toLocaleTimeString('fa-IR')}`;
        document.getElementById('cryptoStatus').textContent = 'داده‌ها دریافت شد';
      } catch (error) {
        document.getElementById('cryptoStatus').textContent = 'خطا در اتصال به Binance';
        console.error('Error loading Binance data:', error);
      }
    }

    async function loadForexRates() {
      document.getElementById('forexStatus').textContent = 'در حال دریافت نرخ ارزها…';
      try {
        // لیست ارزهای مورد نیاز
        const symbols = 'EUR,GBP,AED,TRY,CNY,JPY,IRR,USD';
        const base = state.forexBase;
        
        const res = await fetch(`https://api.exchangerate.host/latest?base=${base}&symbols=${symbols}`, {cache:'no-store'});
        
        if (!res.ok) {
          document.getElementById('forexStatus').textContent = 'خطا در دریافت نرخ ارزها';
          return;
        }
        
        const data = await res.json();
        state.forexRates = data.rates || {};
        
        updateForexDisplay();
        document.getElementById('forexUpdated').textContent = `آخرین بروزرسانی: ${new Date().toLocaleTimeString('fa-IR')}`;
        document.getElementById('forexStatus').textContent = 'داده‌ها دریافت شد';
        
      } catch (error) {
        console.error('Error loading forex rates:', error);
        document.getElementById('forexStatus').textContent = 'خطا در اتصال به سرور ارز';
      }
    }

    function updateForexDisplay() {
      const rates = state.forexRates;
      const base = state.forexBase;
      
      // نمایش نرخ‌ها
      document.getElementById('eurRate').textContent = rates.EUR ? `${formatCurrency(rates.EUR)} EUR` : '—';
      document.getElementById('gbpRate').textContent = rates.GBP ? `${formatCurrency(rates.GBP)} GBP` : '—';
      document.getElementById('aedRate').textContent = rates.AED ? `${formatCurrency(rates.AED)} AED` : '—';
      document.getElementById('tryRate').textContent = rates.TRY ? `${formatCurrency(rates.TRY)} TRY` : '—';
      document.getElementById('cnyRate').textContent = rates.CNY ? `${formatCurrency(rates.CNY)} CNY` : '—';
      document.getElementById('jpyRate').textContent = rates.JPY ? `${formatCurrency(rates.JPY)} JPY` : '—';
      
      // اگر نرخ دلار به ریال موجود باشد، محاسبه و نمایش ریال
      if (state.usdToIrr > 0) {
        // محاسبه هر ارز به ریال
        // ابتدا باید ارز را به USD تبدیل کنیم (اگر ارز پایه USD نیست)
        let usdRate = 1;
        if (base !== 'USD' && rates.USD) {
          usdRate = rates.USD; // نرخ ارز پایه به USD
        }
        
        // محاسبه هر ارز به ریال
        const calculateToIrr = (rate) => {
          if (!rate) return '—';
          // تبدیل ارز به USD (اگر ارز پایه USD نیست)
          const inUsd = base === 'USD' ? rate : rate / usdRate;
          // تبدیل USD به ریال
          const inIrr = inUsd * state.usdToIrr;
          return `ریال ${formatNum(inIrr, {maximumFractionDigits: 0})}`;
        };
        
        document.getElementById('eurToIrr').textContent = calculateToIrr(rates.EUR);
        document.getElementById('gbpToIrr').textContent = calculateToIrr(rates.GBP);
        document.getElementById('aedToIrr').textContent = calculateToIrr(rates.AED);
        document.getElementById('tryToIrr').textContent = calculateToIrr(rates.TRY);
        document.getElementById('cnyToIrr').textContent = calculateToIrr(rates.CNY);
        document.getElementById('jpyToIrr').textContent = calculateToIrr(rates.JPY);
      } else {
        // اگر نرخ دلار به ریال موجود نیست
        document.getElementById('eurToIrr').textContent = 'نرخ ریال در دسترس نیست';
        document.getElementById('gbpToIrr').textContent = 'نرخ ریال در دسترس نیست';
        document.getElementById('aedToIrr').textContent = 'نرخ ریال در دسترس نیست';
        document.getElementById('tryToIrr').textContent = 'نرخ ریال در دسترس نیست';
        document.getElementById('cnyToIrr').textContent = 'نرخ ریال در دسترس نیست';
        document.getElementById('jpyToIrr').textContent = 'نرخ ریال در دسترس نیست';
      }
    }

    function populatePairs(){
      const select = document.getElementById('pairSelect');
      const quote = state.quote;
      const pairs = state.binanceAll.filter(d => d.symbol.endsWith(quote));

      select.innerHTML = `<option value="">— هیچ‌کدام —</option>` + pairs.map(p=>{
        const base = p.symbol.slice(0, p.symbol.length - quote.length);
        return `<option value="${p.symbol}" data-custom-properties="${iconUrl(base)}">${base}/${quote}</option>`;
      }).join('');

      if (state.pairChoices) state.pairChoices.destroy();
      state.pairChoices = new Choices(select, {
        searchEnabled:true, 
        itemSelectText:'', 
        shouldSort:true, 
        position:'auto',
        callbackOnCreateTemplates: function(template) {
          return {
            option: (classNames, data) => {
              const icon = data.customProperties ? `<img src="${data.customProperties}" alt="" onerror="this.style.display='none'">` : '';
              return template(`<div class="${classNames.item} ${classNames.itemSelectable} choice-with-icon" data-id="${data.id}" data-value="${data.value}">${icon}<span class="label">${data.label}</span></div>`);
            },
            item: (classNames, data) => {
              const icon = data.customProperties ? `<img src="${data.customProperties}" alt="" onerror="this.style.display='none'">` : '';
              return template(`<div class="${classNames.item} ${classNames.itemChoice} selected-with-icon" data-item data-id="${data.id}" data-value="${data.value}">${icon}<span class="label">${data.label}</span></div>`);
            }
          };
        }
      });

      select.addEventListener('change', e => renderPairInfo(e.target.value, pairs));
      select.value = '';
      select.dispatchEvent(new Event('change'));
    }

    function renderPairInfo(symbol, pairs){
      const nameEl = document.getElementById('pairName');
      const priceEl = document.getElementById('pairPrice');
      const changeEl = document.getElementById('pairChange');
      const volEl = document.getElementById('pairVolume');
      const tradesEl = document.getElementById('pairTrades');

      if (!symbol) {
        nameEl.innerHTML = '<span class="coin-name">—</span>';
        priceEl.textContent = 'قیمت: —';
        changeEl.textContent = 'تغییر 24h: —';
        volEl.textContent = 'حجم 24h: —';
        tradesEl.textContent = 'تعداد معاملات: —';
        return;
      }
      const info = pairs.find(p => p.symbol === symbol);
      if (!info) return;

      const base = symbol.slice(0, symbol.length - state.quote.length);
      const priceUSD = Number(info.lastPrice);
      const chgNum = Number(info.priceChangePercent);
      const volNum = Number(info.quoteVolume);
      const tradesNum = Number(info.count || 0);

      const priceIRR = state.usdToIrr ? priceUSD * state.usdToIrr : 0;

      nameEl.innerHTML = `<span class="coin-name">${base}/${state.quote}</span>`;
      priceEl.textContent = `قیمت: $${formatNum(priceUSD, {maximumFractionDigits: 8})}` + (state.usdToIrr ? ` | ریال ${formatNum(priceIRR)}` : '');
      changeEl.innerHTML = `تغییر 24h: <span class="${chgNum>=0?'delta-up':'delta-down'}">${formatNum(chgNum, {maximumFractionDigits: 2})}%</span>`;
      volEl.textContent = `حجم 24h: $${formatNum(volNum)}`;
      tradesEl.textContent = `تعداد معاملات: ${formatNum(tradesNum)}`;
    }

    function initQuoteChoices(){
      const select = document.getElementById('quoteSelect');
      if (state.quoteChoices) state.quoteChoices.destroy();
      state.quoteChoices = new Choices(select, {
        searchEnabled:false, 
        itemSelectText:'', 
        shouldSort:false, 
        position:'auto'
      });
      select.addEventListener('change', ()=>{
        state.quote = select.value;
        populatePairs();
      });
    }
    
    function initForexChoices() {
      const select = document.getElementById('forexBaseSelect');
      if (state.forexChoices) state.forexChoices.destroy();
      state.forexChoices = new Choices(select, {
        searchEnabled: false,
        itemSelectText: '',
        shouldSort: false,
        position: 'auto'
      });
      select.addEventListener('change', () => {
        state.forexBase = select.value;
        loadForexRates();
      });
    }

    // Theme toggle
    document.getElementById('toggleTheme').addEventListener('click', ()=>{
      const body = document.body;
      body.setAttribute('data-theme', body.getAttribute('data-theme')==='dark' ? 'light' : 'dark');
    });
    
    document.getElementById('refreshAll').addEventListener('click', ()=>{
      loadUsdToIrr(); 
      loadBinance();
      loadForexRates();
    });

    // Init
    document.addEventListener('DOMContentLoaded', async ()=>{
      new Choices('#langSelect', {searchEnabled:false, itemSelectText:''});
      initQuoteChoices();
      initForexChoices();
      
      await Promise.all([
        loadUsdToIrr(),
        loadBinance(),
        loadForexRates()
      ]);
      
      // refresh intervals
      setInterval(loadUsdToIrr, 5*60*1000);
      setInterval(loadBinance, 60*1000);
      setInterval(loadForexRates, 5*60*1000);
    });

    // Handle window resize
    window.addEventListener('resize', function() {
      if (state.pairChoices) {
        state.pairChoices.destroy();
        setTimeout(() => {
          const select = document.getElementById('pairSelect');
          state.pairChoices = new Choices(select, {
            searchEnabled:true, 
            itemSelectText:'', 
            shouldSort:true, 
            position:'auto',
            callbackOnCreateTemplates: function(template) {
              return {
                option: (classNames, data) => {
                  const icon = data.customProperties ? `<img src="${data.customProperties}" alt="" onerror="this.style.display='none'">` : '';
                  return template(`<div class="${classNames.item} ${classNames.itemSelectable} choice-with-icon" data-id="${data.id}" data-value="${data.value}">${icon}<span class="label">${data.label}</span></div>`);
                },
                item: (classNames, data) => {
                  const icon = data.customProperties ? `<img src="${data.customProperties}" alt="" onerror="this.style.display='none'">` : '';
                  return template(`<div class="${classNames.item} ${classNames.itemChoice} selected-with-icon" data-item data-id="${data.id}" data-value="${data.value}">${icon}<span class="label">${data.label}</span></div>`);
                }
              };
            }
          });
        }, 100);
      }
    });
  </script>
</body>
</html>
