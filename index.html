<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø¯Ø§Ø´Ø¨ÙˆØ± Ø²Ù†Ø¯Ù‡ Ø¨Ø§Ø²Ø§Ø±Ù‡Ø§</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <style>
    :root {
      --bg:#0f1115; --panel:#151823; --text:#e7edf2; --muted:#9aa7b0;
      --accent:#4cc9f0; --up:#1db954; --down:#ff3b30; --border:#222636;
      --card:#12141c; --shadow:0 8px 18px rgba(0,0,0,0.35);
      --field-w:220px;
      --dropdown-bg:#1e2230;
    }
    [data-theme="light"] {
      --bg:#f6f7fb; --panel:#fff; --text:#1a2230; --muted:#5c6b7c;
      --accent:#1f7ae0; --up:#1ea865; --down:#c0392b; --border:#dfe4ea;
      --card:#fff; --shadow:0 8px 18px rgba(0,0,0,0.08);
      --dropdown-bg:#fff;
    }

    body {margin:0; background:var(--bg); color:var(--text); font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Naskh Arabic",Tahoma,Arial;}

    header {position:sticky; top:0; z-index:50; background: color-mix(in oklab, var(--bg) 85%, transparent 15%); border-bottom:1px solid var(--border); backdrop-filter:saturate(1.2) blur(6px);}
    .wrap {max-width:1200px; margin:0 auto; padding:14px;}
    .toolbar {display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
    .toolbar .spacer {flex:1;}
    .toolbar button {background:var(--panel); color:var(--text); border:1px solid var(--border); border-radius:10px; padding:8px 10px; cursor:pointer;}

    .card {background:var(--card); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); overflow:hidden; margin:12px 0;}
    .card h3 {margin:0; padding:10px 14px; border-bottom:1px solid var(--border); font-size:16px;}
    .card .content {padding:10px 14px;}
    .status {font-size:13px; color:var(--muted); margin-top:6px;}

    /* Ø¯Ùˆ Ø³ØªÙˆÙ† Ø«Ø§Ø¨Øª Ø­ØªÛŒ Ø±ÙˆÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ */
    .grid-2 {display:grid; gap:10px; grid-template-columns:1fr 1fr !important;}
    .grid-3 {display:grid; gap:10px; grid-template-columns:1fr 1fr 1fr !important;}
    .grid-4 {display:grid; gap:10px; grid-template-columns:1fr 1fr 1fr 1fr !important;}

    .info-box {border:1px solid var(--border); border-radius:10px; padding:10px; background:var(--panel);}
    .delta-up {color:var(--up); font-weight:600;}
    .delta-down {color:var(--down); font-weight:600;}

    .iframe-box {border:1px solid var(--border); border-radius:10px; overflow:hidden; background:var(--panel);}
    .iframe-box iframe {width:100%; height:280px; border:0;}

    /* ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¬Ù…Ø¹â€ŒÙˆØ¬ÙˆØ± Ùˆ ÛŒÚ©Ø³Ø§Ù†â€ŒØ³Ø§Ø²ÛŒ Ø¸Ø§Ù‡Ø± */
    .field {display:inline-block; width:var(--field-w);}
    .choices {width:var(--field-w);}
    .choices__inner {background:var(--panel); border:1px solid var(--border); border-radius:10px; color:var(--text); padding:8px;}
    
    /* Ù…Ù†ÙˆÛŒ dropdown Ø¨Ø§ Ø±Ù†Ú¯ ØªÛŒØ±Ù‡ */
    .choices__list--dropdown {background:var(--dropdown-bg) !important; border:1px solid var(--border); border-radius:10px; box-shadow:var(--shadow);}
    [data-theme="dark"] .choices__list--dropdown .choices__item,
    [data-theme="dark"] .choices__list--dropdown .choice-with-icon .label {
      color:var(--text) !important;
    }
    .choices__list--dropdown .choices__item--selectable.is-highlighted {background:var(--accent);}
    .choices__list--dropdown .choices__item--selectable.is-highlighted .label {color:#fff !important;}

    /* Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ Ø¨Ø§ Ø¢ÛŒÚ©Ù† Ùˆ ÙÙˆÙ†Øª Ù…Ø´Ú©ÛŒ (Pair) */
    .choice-with-icon {display:flex; align-items:center; gap:8px; padding:8px 10px;}
    .choice-with-icon img {width:20px; height:20px; border-radius:50%; object-fit:contain;}
    .choice-with-icon .label {color:#1a2230 !important; font-weight:600;}
    [data-theme="dark"] .choice-with-icon .label {color:var(--text) !important;}

    /* Ø¢ÛŒØªÙ… Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ Ø¯Ø§Ø®Ù„ Ú©Ù†ØªØ±Ù„ */
    .selected-with-icon {display:inline-flex; align-items:center; gap:8px;}
    .selected-with-icon img {width:18px; height:18px; border-radius:50%; object-fit:contain;}
    .selected-with-icon .label {color:var(--text); font-weight:600;}

    /* Ù†Ø§Ù… Ø§Ø±Ø² Ø¯Ø± Ú©Ø§Ø±Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª */
    .coin-name {color:#ffd166; font-weight:700; letter-spacing:0.2px;}
    [data-theme="light"] .coin-name {color:#1a2230;}

    /* Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ù†Ø±Ø® Ø§Ø±Ø² */
    .currency-cards {display:grid; gap:12px; grid-template-columns:repeat(auto-fill, minmax(250px, 1fr));}
    .currency-card {border:1px solid var(--border); border-radius:10px; padding:12px; background:var(--panel); transition:transform 0.2s;}
    .currency-card:hover {transform:translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,0.1);}
    .currency-card-header {display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;}
    .currency-card-title {display:flex; align-items:center; gap:8px; font-weight:600;}
    .currency-flag {width:24px; height:18px; border-radius:3px; object-fit:cover;}
    .currency-price {font-size:18px; font-weight:700; margin:4px 0;}
    .currency-change {font-size:14px; display:flex; align-items:center; gap:6px;}
    .currency-time {font-size:12px; color:var(--muted); margin-top:4px;}
    
    /* Ø±ÛŒØ§Ù„ Ø§ÛŒØ±Ø§Ù† - Ù‡Ø§ÛŒÙ„Ø§ÛŒØª ÙˆÛŒÚ˜Ù‡ */
    .irr-card {border:2px solid #ffd166; background:color-mix(in oklab, var(--panel) 90%, #ffd166 10%);}
    .irr-card .currency-price {color:#ffd166;}
    [data-theme="light"] .irr-card .currency-price {color:#d4a017;}
    
    /* Ø¬Ø¯ÙˆÙ„ Ù†Ø±Ø® Ø§Ø±Ø²Ù‡Ø§ */
    .currency-table {width:100%; border-collapse:collapse; margin-top:10px;}
    .currency-table th, .currency-table td {padding:10px; text-align:center; border-bottom:1px solid var(--border);}
    .currency-table th {background:color-mix(in oklab, var(--panel) 80%, var(--accent) 20%); font-weight:600;}
    .currency-table tr:hover {background:color-mix(in oklab, var(--panel) 90%, transparent);}
    
    /* Ø±ÛŒØ§Ù„ Ø§ÛŒØ±Ø§Ù† Ø¯Ø± Ø¬Ø¯ÙˆÙ„ */
    .irr-row {background:color-mix(in oklab, var(--panel) 90%, #ffd166 10%) !important;}
    .irr-row:hover {background:color-mix(in oklab, var(--panel) 80%, #ffd166 20%) !important;}
    
    /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ */
    .view-toggle {display:flex; gap:10px; margin-bottom:12px;}
    .view-toggle button {background:var(--panel); border:1px solid var(--border); border-radius:8px; padding:6px 12px; cursor:pointer; color:var(--text);}
    .view-toggle button.active {background:var(--accent); color:white; border-color:var(--accent);}
    
    /* Ù„ÙˆÚ¯ÙˆÛŒ Ø§ÛŒØ±Ø§Ù† */
    .iran-logo {color:#ffd166; font-weight:700;}
  </style>
</head>
<body data-theme="dark">
  <header>
    <div class="wrap toolbar">
      <strong id="title">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ± Ø²Ù†Ø¯Ù‡ Ø¨Ø§Ø²Ø§Ø±Ù‡Ø§ <span class="iran-logo">Ø§ÛŒØ±Ø§Ù†</span></strong>
      <span class="status" id="badge">Ø¨Ø¯ÙˆÙ†â€ŒØ³Ø±ÙˆØ± â€¢ Ù…Ù†Ø§Ø³Ø¨ GitHub Pages</span>
      <div class="spacer"></div>
      <select id="langSelect" class="field">
        <option value="fa">ÙØ§Ø±Ø³ÛŒ</option>
        <option value="en">English</option>
      </select>
      <button id="toggleTheme">ØªÙ… Ø±ÙˆØ´Ù†/ØªØ§Ø±ÛŒÚ©</button>
      <button id="refreshAll">ğŸ”„ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
    </div>
  </header>

  <main class="wrap">
    <!-- Ù†Ø±Ø® Ø§Ø±Ø²Ù‡Ø§ÛŒ Ø§ÛŒØ±Ø§Ù†ÛŒ -->
    <section class="card" id="currencyCard">
      <h3>ğŸ’° Ù†Ø±Ø® Ø§Ø±Ø²Ù‡Ø§ÛŒ Ø¬Ù‡Ø§Ù†ÛŒ Ø¨Ù‡ Ø±ÛŒØ§Ù„ Ø§ÛŒØ±Ø§Ù†</h3>
      <div class="content">
        <div class="view-toggle">
          <button id="viewCards" class="active">Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§</button>
          <button id="viewTable">Ø¬Ø¯ÙˆÙ„</button>
        </div>
        
        <div class="status" id="currencyStatus">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø±Ø® Ø§Ø±Ø²Ù‡Ø§ Ø§Ø² Ø³Ø±ÙˆØ± Ø§ÛŒØ±Ø§Ù†ÛŒ...</div>
        
        <!-- Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ -->
        <div id="cardsView" class="currency-cards">
          <div class="currency-card irr-card">
            <div class="currency-card-header">
              <div class="currency-card-title">
                <img src="https://flagcdn.com/w20/ir.png" alt="Ø§ÛŒØ±Ø§Ù†" class="currency-flag" onerror="this.style.display='none'">
                <span>Ø±ÛŒØ§Ù„ Ø§ÛŒØ±Ø§Ù†</span>
              </div>
            </div>
            <div class="currency-price">1 Ø±ÛŒØ§Ù„</div>
            <div class="currency-change">
              <span>ÙˆØ§Ø­Ø¯ Ù¾ÙˆÙ„ Ø§ÛŒØ±Ø§Ù†</span>
            </div>
            <div class="currency-time">Ù¾Ø§ÛŒÙ‡ Ù…Ø­Ø§Ø³Ø¨Ø§Øª</div>
          </div>
          <!-- Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø²Ù‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
        </div>
        
        <!-- Ù†Ù…Ø§ÛŒØ´ Ø¬Ø¯ÙˆÙ„ -->
        <div id="tableView" style="display:none;">
          <table class="currency-table">
            <thead>
              <tr>
                <th>Ù¾Ø±Ú†Ù…</th>
                <th>Ø§Ø±Ø²</th>
                <th>Ù†Ø±Ø® (Ø±ÛŒØ§Ù„)</th>
                <th>ØªØºÛŒÛŒØ± (Ø±ÛŒØ§Ù„)</th>
                <th>Ø¯Ø±ØµØ¯ ØªØºÛŒÛŒØ±</th>
                <th>Ø¨Ù‡ Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</th>
              </tr>
            </thead>
            <tbody id="currencyTableBody">
              <tr class="irr-row">
                <td><img src="https://flagcdn.com/w20/ir.png" alt="Ø§ÛŒØ±Ø§Ù†" class="currency-flag"></td>
                <td><strong>Ø±ÛŒØ§Ù„ Ø§ÛŒØ±Ø§Ù†</strong></td>
                <td><strong>1</strong></td>
                <td>0</td>
                <td>0%</td>
                <td>Ù¾Ø§ÛŒÙ‡</td>
              </tr>
              <!-- Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø²Ù‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
            </tbody>
          </table>
        </div>
        
        <div class="status" id="currencyUpdated">Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: â€”</div>
      </div>
    </section>

    <!-- Ú©Ø±ÛŒÙ¾ØªÙˆ -->
    <section class="card" id="cryptoCard">
      <h3 id="cryptoTitle">ğŸª™ Ú©Ø±ÛŒÙ¾ØªÙˆ Ø§Ø² Binance (24h)</h3>
      <div class="content">
        <div class="status" id="cryptoStatus">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØªâ€¦</div>

        <div class="grid-2" style="margin-top:8px;">
          <div class="info-box">
            <label id="quoteLabel" for="quoteSelect">Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ø² Ù…Ø¨Ù†Ø§ (Quote):</label>
            <select id="quoteSelect" class="field">
              <option value="USDT">USDT</option>
              <option value="BUSD">BUSD</option>
              <option value="USDC">USDC</option>
              <option value="BTC">BTC</option>
            </select>
          </div>
          <div class="info-box">
            <label id="pairLabel" for="pairSelect">Ø§Ù†ØªØ®Ø§Ø¨ Ø¬ÙØªâ€ŒØ§Ø±Ø²:</label>
            <select id="pairSelect" class="field"><option value="">â€” Ù‡ÛŒÚ†â€ŒÚ©Ø¯Ø§Ù… â€”</option></select>
            <div class="status" id="pairHint">USDT/USDC/BUSD ØªÙˆØµÛŒÙ‡â€ŒØ´Ø¯Ù‡</div>
          </div>
        </div>

        <div class="grid-2" style="margin-top:8px;">
          <div class="info-box">
            <strong id="pairName">â€”</strong>
            <div id="pairPrice">Ù‚ÛŒÙ…Øª: â€”</div>
            <div id="pairChange">ØªØºÛŒÛŒØ± 24h: â€”</div>
          </div>
          <div class="info-box">
            <div id="pairVolume">Ø­Ø¬Ù… 24h: â€”</div>
            <div id="pairTrades">ØªØ¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª: â€”</div>
            <div class="status" id="cryptoUpdated">â€”</div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script>
    const state = { 
      quote:'USDT', 
      binanceAll:[], 
      pairChoices:null, 
      quoteChoices:null, 
      usdToIrr:0,
      currencyRates: [],
      currentView: 'cards'
    };

    // API Ø§ÛŒØ±Ø§Ù†ÛŒ TGJU - Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ API Key
    const TGJU_API_URL = 'https://api.tgju.online/v1/data/sana/json';

    function iconUrl(base){ 
      return `https://cryptoicon-api.vercel.app/api/icon/${base.toLowerCase()}`; 
    }
    
    function formatNum(n, opts){ 
      if (n === undefined || n === null) return 'â€”';
      try { 
        return Number(n).toLocaleString('fa-IR', opts || {}); 
      } catch(e){ 
        return n; 
      } 
    }
    
    function formatCurrency(num) {
      // ÙØ±Ù…Øª Ø§Ø¹Ø¯Ø§Ø¯ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø²Ø±Ú¯
      if (num >= 1000000000) {
        return formatNum((num / 1000000000).toFixed(2)) + ' Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯';
      } else if (num >= 1000000) {
        return formatNum((num / 1000000).toFixed(2)) + ' Ù…ÛŒÙ„ÛŒÙˆÙ†';
      } else {
        return formatNum(num);
      }
    }

    // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø±Ø® Ø¯Ù„Ø§Ø± Ø¨Ù‡ Ø±ÛŒØ§Ù„
    async function loadUsdToIrr(){
      try{
        // Ø§Ø² API Ø§ÛŒØ±Ø§Ù†ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø±Ø® Ø¯Ù„Ø§Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        await loadCurrencyRates();
        // Ø¨Ø¹Ø¯ Ø§Ø² Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø±Ø® Ø§Ø±Ø²Ù‡Ø§ØŒ Ù†Ø±Ø® Ø¯Ù„Ø§Ø± Ø¨Ù‡ Ø±ÛŒØ§Ù„ Ø±Ø§ Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        if (state.currencyRates.USD) {
          state.usdToIrr = state.currencyRates.USD.price;
        } else {
          state.usdToIrr = 0;
        }
      }catch(e){ 
        state.usdToIrr = 0; 
        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù†Ø±Ø® Ø¯Ù„Ø§Ø±:', e);
      }
    }

    // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Binance
    async function loadBinance(){
      document.getElementById('cryptoStatus').textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² Binanceâ€¦';
      try {
        const res = await fetch('https://api.binance.com/api/v3/ticker/24hr', {cache:'no-store'});
        if (!res.ok) { 
          document.getElementById('cryptoStatus').textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Binance'; 
          return; 
        }
        state.binanceAll = await res.json();
        populatePairs();
        document.getElementById('cryptoUpdated').textContent = `Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ${new Date().toLocaleTimeString('fa-IR')}`;
      } catch(e) {
        document.getElementById('cryptoStatus').textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Binance';
        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Binance:', e);
      }
    }

    // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø±Ø® Ø§Ø±Ø²Ù‡Ø§ÛŒ Ø¬Ù‡Ø§Ù†ÛŒ Ø§Ø² API Ø§ÛŒØ±Ø§Ù†ÛŒ
    async function loadCurrencyRates(){
      document.getElementById('currencyStatus').textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø±Ø® Ø§Ø±Ø²Ù‡Ø§ Ø§Ø² Ø³Ø±ÙˆØ± Ø§ÛŒØ±Ø§Ù†ÛŒ...';
      
      try {
        const res = await fetch(TGJU_API_URL, {cache: 'no-store'});
        
        if (!res.ok) {
          throw new Error(`Ø®Ø·Ø§ÛŒ HTTP: ${res.status}`);
        }
        
        const data = await res.json();
        
        if (data && data.sana) {
          // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø§Ø² API Ø§ÛŒØ±Ø§Ù†ÛŒ
          const rates = {};
          
          // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø±Ø²Ù‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ API
          const currencyMappings = {
            'USD': ['sana_buy_usd', 'price_dollar_rl'],
            'EUR': ['sana_buy_eur', 'price_eur'],
            'GBP': ['sana_buy_gbp', 'price_gbp'],
            'AED': ['sana_buy_aed', 'price_aed'],
            'TRY': ['sana_buy_try', 'price_try'],
            'CNY': ['sana_buy_cny', 'price_cny'],
            'CAD': ['sana_buy_cad', 'price_cad'],
            'AUD': ['sana_buy_aud', 'price_aud'],
            'JPY': ['sana_buy_jpy', 'price_jpy'],
            'CHF': ['sana_buy_chf', 'price_chf'],
            'RUB': ['sana_buy_rub', 'price_rub'],
            'INR': ['sana_buy_inr', 'price_inr']
          };
          
          // ØªØ¨Ø¯ÛŒÙ„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ API Ø¨Ù‡ ÙØ±Ù…Øª Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø±
          Object.entries(currencyMappings).forEach(([currencyCode, apiKeys]) => {
            for (const apiKey of apiKeys) {
              if (data.sana[apiKey]) {
                const item = data.sana[apiKey];
                let price = 0;
                let change = 0;
                let percentChange = 0;
                
                // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¨Ø³ØªÙ‡ Ø¨Ù‡ Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø§Ø¯Ù‡
                if (typeof item === 'object' && item !== null) {
                  if (item.p) price = parseFloat(item.p.replace(/,/g, ''));
                  if (item.d) change = parseFloat(item.d.replace(/,/g, ''));
                  if (item.dp) percentChange = parseFloat(item.dp.replace('%', ''));
                  
                  // Ø§Ú¯Ø± Ù‡Ù†ÙˆØ² Ù‚ÛŒÙ…Øª Ù†Ø¯Ø§Ø±ÛŒÙ…ØŒ Ø§Ø² ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± ØªÙ„Ø§Ø´ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                  if (!price && item.value) price = parseFloat(item.value.replace(/,/g, ''));
                } else if (typeof item === 'string') {
                  price = parseFloat(item.replace(/,/g, ''));
                }
                
                if (price > 0) {
                  rates[currencyCode] = {
                    price: price,
                    change: change,
                    percentChange: percentChange,
                    timestamp: new Date().toISOString()
                  };
                  break; // Ø§ÙˆÙ„ÛŒÙ† Ù…Ù‚Ø¯Ø§Ø± Ù…Ø¹ØªØ¨Ø± Ø±Ø§ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ…
                }
              }
            }
          });
          
          // Ø§ÙØ²ÙˆØ¯Ù† Ø±ÛŒØ§Ù„ Ø§ÛŒØ±Ø§Ù†
          rates['IRR'] = {
            price: 1,
            change: 0,
            percentChange: 0,
            timestamp: new Date().toISOString()
          };
          
          state.currencyRates = rates;
          
          // Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
          displayCurrencyData(rates);
          document.getElementById('currencyUpdated').textContent = `Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ${new Date().toLocaleTimeString('fa-IR')}`;
          document.getElementById('currencyStatus').textContent = `Ù†Ø±Ø® ${Object.keys(rates).length} Ø§Ø±Ø² Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯`;
          document.getElementById('currencyStatus').style.color = 'var(--up)';
          
        } else {
          throw new Error('Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø§Ø¯Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
        }
      } catch(e) {
        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù†Ø±Ø® Ø§Ø±Ø²Ù‡Ø§:', e);
        document.getElementById('currencyStatus').textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù†Ø±Ø® Ø§Ø±Ø²Ù‡Ø§ - Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡';
        document.getElementById('currencyStatus').style.color = 'var(--down)';
        
        // Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡ Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§
        displaySampleCurrencyData();
      }
    }

    // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø²ÛŒ
    function displayCurrencyData(rates) {
      const cardsView = document.getElementById('cardsView');
      const tableBody = document.getElementById('currencyTableBody');
      
      // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù…Ø­ØªÙˆØ§ÛŒ Ù‚Ø¨Ù„ÛŒ (Ø¨Ù‡ Ø¬Ø² Ø±ÛŒØ§Ù„ Ø§ÛŒØ±Ø§Ù†)
      const existingCards = cardsView.querySelectorAll('.currency-card:not(.irr-card)');
      existingCards.forEach(card => card.remove());
      
      // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÙˆÙ„ (Ø¨Ù‡ Ø¬Ø² Ø±ÛŒØ§Ù„ Ø§ÛŒØ±Ø§Ù†)
      const existingRows = tableBody.querySelectorAll('tr:not(.irr-row)');
      existingRows.forEach(row => row.remove());
      
      // Ù¾Ø±Ú†Ù… Ú©Ø´ÙˆØ±Ù‡Ø§
      const flags = {
        'USD': 'https://flagcdn.com/w20/us.png',
        'EUR': 'https://flagcdn.com/w20/eu.png',
        'GBP': 'https://flagcdn.com/w20/gb.png',
        'CNY': 'https://flagcdn.com/w20/cn.png',
        'TRY': 'https://flagcdn.com/w20/tr.png',
        'AED': 'https://flagcdn.com/w20/ae.png',
        'CAD': 'https://flagcdn.com/w20/ca.png',
        'AUD': 'https://flagcdn.com/w20/au.png',
        'JPY': 'https://flagcdn.com/w20/jp.png',
        'CHF': 'https://flagcdn.com/w20/ch.png',
        'RUB': 'https://flagcdn.com/w20/ru.png',
        'INR': 'https://flagcdn.com/w20/in.png',
        'IRR': 'https://flagcdn.com/w20/ir.png'
      };
      
      // Ù†Ø§Ù… Ø§Ø±Ø²Ù‡Ø§
      const currencyNames = {
        'USD': 'Ø¯Ù„Ø§Ø± Ø¢Ù…Ø±ÛŒÚ©Ø§',
        'EUR': 'ÛŒÙˆØ±Ùˆ Ø§Ø±ÙˆÙ¾Ø§',
        'GBP': 'Ù¾ÙˆÙ†Ø¯ Ø§Ù†Ú¯Ù„ÛŒØ³',
        'CNY': 'ÛŒÙˆØ§Ù† Ú†ÛŒÙ†',
        'TRY': 'Ù„ÛŒØ± ØªØ±Ú©ÛŒÙ‡',
        'AED': 'Ø¯Ø±Ù‡Ù… Ø§Ù…Ø§Ø±Ø§Øª',
        'CAD': 'Ø¯Ù„Ø§Ø± Ú©Ø§Ù†Ø§Ø¯Ø§',
        'AUD': 'Ø¯Ù„Ø§Ø± Ø§Ø³ØªØ±Ø§Ù„ÛŒØ§',
        'JPY': 'ÛŒÙ† Ú˜Ø§Ù¾Ù†',
        'CHF': 'ÙØ±Ø§Ù†Ú© Ø³ÙˆØ¦ÛŒØ³',
        'RUB': 'Ø±ÙˆØ¨Ù„ Ø±ÙˆØ³ÛŒÙ‡',
        'INR': 'Ø±ÙˆÙ¾ÛŒÙ‡ Ù‡Ù†Ø¯',
        'IRR': 'Ø±ÛŒØ§Ù„ Ø§ÛŒØ±Ø§Ù†'
      };
      
      // ØªØ±ØªÛŒØ¨ Ù†Ù…Ø§ÛŒØ´ Ø§Ø±Ø²Ù‡Ø§
      const displayOrder = ['USD', 'EUR', 'GBP', 'AED', 'TRY', 'CAD', 'AUD', 'JPY', 'CHF', 'CNY', 'RUB', 'INR'];
      
      // Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ Ùˆ Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÙˆÙ„
      displayOrder.forEach(currencyCode => {
        const rate = rates[currencyCode];
        if (!rate) return;
        
        const changePercent = rate.percentChange;
        const changeClass = changePercent >= 0 ? 'delta-up' : 'delta-down';
        const changeSign = changePercent >= 0 ? '+' : '';
        const timeStr = new Date(rate.timestamp).toLocaleTimeString('fa-IR', {hour: '2-digit', minute:'2-digit'});
        
        // Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Øª
        const card = document.createElement('div');
        card.className = 'currency-card';
        if (currencyCode === 'IRR') card.classList.add('irr-card');
        
        card.innerHTML = `
          <div class="currency-card-header">
            <div class="currency-card-title">
              <img src="${flags[currencyCode] || 'https://flagcdn.com/w20/un.png'}" 
                   alt="${currencyCode}" 
                   class="currency-flag"
                   onerror="this.style.display='none'">
              <span>${currencyCode} - ${currencyNames[currencyCode] || currencyCode}</span>
            </div>
          </div>
          <div class="currency-price">${formatCurrency(rate.price)} Ø±ÛŒØ§Ù„</div>
          <div class="currency-change">
            <span class="${changeClass}">${changeSign}${formatNum(changePercent, {maximumFractionDigits: 2})}%</span>
            <span>(${changeSign}${formatNum(rate.change)} Ø±ÛŒØ§Ù„)</span>
          </div>
          <div class="currency-time">${timeStr}</div>
        `;
        
        if (currencyCode !== 'IRR') {
          cardsView.appendChild(card);
        }
        
        // Ø§ÛŒØ¬Ø§Ø¯ Ø±Ø¯ÛŒÙ Ø¬Ø¯ÙˆÙ„
        const row = document.createElement('tr');
        if (currencyCode === 'IRR') row.classList.add('irr-row');
        
        row.innerHTML = `
          <td>
            <img src="${flags[currencyCode] || 'https://flagcdn.com/w20/un.png'}" 
                 alt="${currencyCode}" 
                 class="currency-flag"
                 onerror="this.style.display='none'">
          </td>
          <td>
            <div style="display:flex; align-items:center; gap:5px;">
              <strong>${currencyCode}</strong>
              <span style="font-size:12px; color:var(--muted)">${currencyNames[currencyCode] || currencyCode}</span>
            </div>
          </td>
          <td><strong>${formatCurrency(rate.price)}</strong></td>
          <td>${changeSign}${formatNum(rate.change)}</td>
          <td><span class="${changeClass}">${changeSign}${formatNum(changePercent, {maximumFractionDigits: 2})}%</span></td>
          <td style="font-size:12px;">${timeStr}</td>
        `;
        
        if (currencyCode !== 'IRR') {
          tableBody.appendChild(row);
        }
      });
    }

    // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡ (Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ Ø¯Ø± API)
    function displaySampleCurrencyData() {
      const sampleRates = {
        'USD': { price: 420000, change: 1250, percentChange: 0.3, timestamp: new Date().toISOString() },
        'EUR': { price: 450000, change: -800, percentChange: -0.18, timestamp: new Date().toISOString() },
        'GBP': { price: 530000, change: 1500, percentChange: 0.28, timestamp: new Date().toISOString() },
        'TRY': { price: 13000, change: 150, percentChange: 1.17, timestamp: new Date().toISOString() },
        'AED': { price: 114000, change: 300, percentChange: 0.26, timestamp: new Date().toISOString() },
        'CAD': { price: 310000, change: 800, percentChange: 0.26, timestamp: new Date().toISOString() },
        'CNY': { price: 58000, change: -200, percentChange: -0.34, timestamp: new Date().toISOString() },
        'IRR': { price: 1, change: 0, percentChange: 0, timestamp: new Date().toISOString() }
      };
      
      displayCurrencyData(sampleRates);
    }

    // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ù†Ù…Ø§ÛŒØ´ (Ú©Ø§Ø±Øª/Ø¬Ø¯ÙˆÙ„)
    function setupViewToggle() {
      const cardsView = document.getElementById('cardsView');
      const tableView = document.getElementById('tableView');
      const viewCardsBtn = document.getElementById('viewCards');
      const viewTableBtn = document.getElementById('viewTable');
      
      viewCardsBtn.addEventListener('click', () => {
        cardsView.style.display = 'grid';
        tableView.style.display = 'none';
        viewCardsBtn.classList.add('active');
        viewTableBtn.classList.remove('active');
        state.currentView = 'cards';
      });
      
      viewTableBtn.addEventListener('click', () => {
        cardsView.style.display = 'none';
        tableView.style.display = 'block';
        viewCardsBtn.classList.remove('active');
        viewTableBtn.classList.add('active');
        state.currentView = 'table';
      });
    }

    function populatePairs(){
      const select = document.getElementById('pairSelect');
      const quote = state.quote;
      const pairs = state.binanceAll.filter(d => d.symbol.endsWith(quote));

      select.innerHTML = `<option value="">â€” Ù‡ÛŒÚ†â€ŒÚ©Ø¯Ø§Ù… â€”</option>` + pairs.map(p=>{
        const base = p.symbol.slice(0, p.symbol.length - quote.length);
        return `<option value="${p.symbol}" data-custom-properties="${iconUrl(base)}">${base}/${quote}</option>`;
      }).join('');

      if (state.pairChoices) state.pairChoices.destroy();
      state.pairChoices = new Choices(select, {
        searchEnabled:true, itemSelectText:'', shouldSort:true, position:'bottom',
        callbackOnCreateTemplates: function(template) {
          return {
            option: (classNames, data) => {
              const icon = data.customProperties ? `<img src="${data.customProperties}" alt="" onerror="this.style.display='none'">` : '';
              return template(`<div class="${classNames.item} ${classNames.itemSelectable} choice-with-icon" data-id="${data.id}" data-value="${data.value}">${icon}<span class="label">${data.label}</span></div>`);
            },
            item: (classNames, data) => {
              const icon = data.customProperties ? `<img src="${data.customProperties}" alt="" onerror="this.style.display='none'">` : '';
              return template(`<div class="${classNames.item} ${classNames.itemChoice} selected-with-icon" data-item data-id="${data.id}" data-value="${data.value}">${icon}<span class="label">${data.label}</span></div>`);
            }
          };
        }
      });

      select.addEventListener('change', e => renderPairInfo(e.target.value, pairs));
      select.value = '';
      select.dispatchEvent(new Event('change'));
    }

    function renderPairInfo(symbol, pairs){
      const nameEl = document.getElementById('pairName');
      const priceEl = document.getElementById('pairPrice');
      const changeEl = document.getElementById('pairChange');
      const volEl = document.getElementById('pairVolume');
      const tradesEl = document.getElementById('pairTrades');

      if (!symbol) {
        nameEl.innerHTML = '<span class="coin-name">â€”</span>';
        priceEl.textContent = 'Ù‚ÛŒÙ…Øª: â€”';
        changeEl.textContent = 'ØªØºÛŒÛŒØ± 24h: â€”';
        volEl.textContent = 'Ø­Ø¬Ù… 24h: â€”';
        tradesEl.textContent = 'ØªØ¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª: â€”';
        return;
      }
      const info = pairs.find(p => p.symbol === symbol);
      if (!info) return;

      const base = symbol.slice(0, symbol.length - state.quote.length);
      const priceUSD = Number(info.lastPrice);
      const chgNum = Number(info.priceChangePercent);
      const volNum = Number(info.quoteVolume);
      const tradesNum = Number(info.count || 0);

      const priceIRR = state.usdToIrr ? priceUSD * state.usdToIrr : 0;

      nameEl.innerHTML = `<span class="coin-name">${base}/${state.quote}</span>`;
      priceEl.textContent = `Ù‚ÛŒÙ…Øª: $${formatNum(priceUSD, {maximumFractionDigits: 8})}` + (state.usdToIrr ? ` | Ø±ÛŒØ§Ù„ ${formatNum(priceIRR)}` : '');
      changeEl.innerHTML = `ØªØºÛŒÛŒØ± 24h: <span class="${chgNum>=0?'delta-up':'delta-down'}">${formatNum(chgNum, {maximumFractionDigits: 2})}%</span>`;
      volEl.textContent = `Ø­Ø¬Ù… 24h: $${formatNum(volNum)}`;
      tradesEl.textContent = `ØªØ¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª: ${formatNum(tradesNum)}`;
    }

    function initQuoteChoices(){
      const select = document.getElementById('quoteSelect');
      if (state.quoteChoices) state.quoteChoices.destroy();
      state.quoteChoices = new Choices(select, {searchEnabled:false, itemSelectText:'', shouldSort:false, position:'bottom'});
      select.addEventListener('change', ()=>{
        state.quote = select.value;
        populatePairs();
      });
    }

    // ØªØºÛŒÛŒØ± ØªÙ…
    document.getElementById('toggleTheme').addEventListener('click', ()=>{
      const body = document.body;
      body.setAttribute('data-theme', body.getAttribute('data-theme')==='dark' ? 'light' : 'dark');
    });
    
    // Ø±ÙØ±Ø´ Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
    document.getElementById('refreshAll').addEventListener('click', ()=>{
      document.getElementById('refreshAll').textContent = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ...';
      loadCurrencyRates().then(() => {
        loadUsdToIrr();
        loadBinance();
        setTimeout(() => {
          document.getElementById('refreshAll').textContent = 'ğŸ”„ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ';
        }, 1000);
      });
    });

    // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
    document.addEventListener('DOMContentLoaded', async ()=>{
      new Choices('#langSelect', {searchEnabled:false, itemSelectText:''});
      initQuoteChoices();
      setupViewToggle();
      
      // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
      await Promise.all([
        loadCurrencyRates(),
        loadUsdToIrr(),
        loadBinance()
      ]);
      
      // ØªÙ†Ø¸ÛŒÙ… Ø¨Ø§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ Ø±ÙØ±Ø´ Ø®ÙˆØ¯Ú©Ø§Ø±
      setInterval(loadUsdToIrr, 5*60*1000); // Ù‡Ø± 5 Ø¯Ù‚ÛŒÙ‚Ù‡
      setInterval(loadBinance, 60*1000); // Ù‡Ø± Ø¯Ù‚ÛŒÙ‚Ù‡
      setInterval(loadCurrencyRates, 2*60*1000); // Ù‡Ø± 2 Ø¯Ù‚ÛŒÙ‚Ù‡
    });
  </script>
</body>
</html>
