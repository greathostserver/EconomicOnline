<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>داشبور زنده بازارها</title>
  <meta name="description" content="نمایش زنده ارزهای دیجیتال با جدول حرفه‌ای، جستجو و مرتب‌سازی، به‌همراه ارزهای جهان و ویجت کامودیتی‌ها. آماده برای GitHub Pages." />
  <link rel="preconnect" href="https://api.coingecko.com">
  <link rel="preconnect" href="https://api.frankfurter.app">
  <style>
    :root {
      --bg: #0f1115; --panel: #151823; --text: #e7edf2; --muted: #9aa7b0;
      --accent: #4cc9f0; --up: #1db954; --down: #ff3b30; --border: #222636;
      --card: #12141c; --shadow: 0 8px 18px rgba(0,0,0,0.35);
      --table-row: #1a1f2b; --table-row-alt: #151a24;
    }
    [data-theme="light"] {
      --bg: #f6f7fb; --panel: #ffffff; --text: #1a2230; --muted: #5c6b7c;
      --accent: #1f7ae0; --up: #1ea865; --down: #c0392b; --border: #dfe4ea;
      --card: #ffffff; --shadow: 0 8px 18px rgba(0,0,0,0.08);
      --table-row: #ffffff; --table-row-alt: #f3f6fa;
    }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Naskh Arabic", "Tahoma", Arial;
    }
    header { position: sticky; top: 0; z-index: 50; backdrop-filter: saturate(1.2) blur(6px);
      background: color-mix(in oklab, var(--bg) 80%, transparent 20%);
      border-bottom: 1px solid var(--border); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 14px; }
    .toolbar { display:flex; align-items:center; gap:10px; flex-wrap: wrap; }
    .toolbar select, .toolbar button, .toolbar input {
      background: var(--panel); color: var(--text); border: 1px solid var(--border);
      border-radius: 10px; padding: 8px 10px; cursor: pointer;
    }
    .row { display: grid; gap: 14px; grid-template-columns: 1fr; }
    @media (min-width: 900px) { .row { grid-template-columns: 2fr 1fr; } }
    .card { background: var(--card); border: 1px solid var(--border);
      border-radius: 12px; box-shadow: var(--shadow); overflow: hidden; }
    .card h3 { margin: 0; padding: 10px 14px; border-bottom: 1px solid var(--border); font-size: 16px; }
    .card .content { padding: 10px 14px; }
    .status { font-size: 13px; color: var(--muted); margin-top: 6px; }
    .badge { font-size: 13px; color: var(--muted); }
    .footer { padding: 16px; text-align: center; color: var(--muted); }

    /* Table */
    .table-wrap { overflow: auto; border: 1px solid var(--border); border-radius: 10px; }
    table { width: 100%; border-collapse: collapse; min-width: 680px; }
    thead th {
      background: var(--panel); color: var(--text); border-bottom: 1px solid var(--border);
      padding: 10px; font-weight: 600; text-align: left; cursor: pointer; position: sticky; top: 0;
    }
    tbody td { padding: 10px; border-bottom: 1px solid var(--border); }
    tbody tr:nth-child(odd) { background: var(--table-row); }
    tbody tr:nth-child(even) { background: var(--table-row-alt); }
    .name-cell { display:flex; align-items:center; gap:10px; }
    .name-cell img { width: 20px; height: 20px; border-radius: 50%; border: 1px solid var(--border); }
    .delta-up { color: var(--up); font-weight: 600; }
    .delta-down { color: var(--down); font-weight: 600; }

    /* Iframes grid */
    .grid { display:grid; gap: 10px; grid-template-columns: 1fr; }
    @media (min-width: 760px) { .grid { grid-template-columns: repeat(2, 1fr); } }
    .iframe-box { border: 1px solid var(--border); border-radius: 10px; overflow: hidden; background: var(--panel); }
    .iframe-box iframe { width: 100%; height: 280px; border: 0; }
  </style>
</head>
<body data-theme="dark">
  <header>
    <div class="wrap toolbar">
      <strong id="title">داشبور زنده بازارها</strong>
      <span class="badge" id="badge">بدون‌سرور • مناسب GitHub Pages</span>
      <div style="flex:1"></div>
      <input id="cryptoSearch" type="text" placeholder="جستجو ارز…" aria-label="Search coin" />
      <select id="langSelect" aria-label="Language">
        <option value="fa">فارسی</option>
        <option value="ar">العربية</option>
        <option value="en">English</option>
        <option value="ru">Русский</option>
      </select>
      <button id="toggleTheme">تم روشن/تاریک</button>
      <button id="refreshAll">به‌روزرسانی</button>
    </div>
  </header>

  <main class="wrap">
    <div class="row">
      <section class="card" id="cryptoCard">
        <h3 id="cryptoTitle">ارزهای دیجیتال</h3>
        <div class="content">
          <div class="status" id="cryptoStatus">در حال بارگذاری از CoinGecko…</div>
          <div class="table-wrap">
            <table id="cryptoTable">
              <thead>
                <tr>
                  <th data-key="name" id="thName">نام</th>
                  <th data-key="current_price" id="thPrice">قیمت</th>
                  <th data-key="price_change_percentage_24h" id="thChange">تغییر 24h</th>
                  <th data-key="market_cap" id="thCap">مارکت کپ</th>
                  <th data-key="total_volume" id="thVol">حجم 24h</th>
                </tr>
              </thead>
              <tbody id="cryptoBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="card" id="forexCard">
        <h3 id="forexTitle">ارزهای جهان (Forex)</h3>
        <div class="content">
          <div class="status" id="forexStatus">در حال دریافت از Frankfurter…</div>
          <div class="table-wrap">
            <table id="forexTable">
              <thead>
                <tr>
                  <th id="fxPairHdr">جفت ارز</th>
                  <th id="fxRateHdr">نرخ</th>
                </tr>
              </thead>
              <tbody id="forexBody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>

    <section class="card" id="commoditiesCard" style="margin-top:12px;">
      <h3 id="commoditiesTitle">طلا و کامودیتی‌ها</h3>
      <div class="content grid">
        <div class="iframe-box">
          <iframe src="https://s.tradingview.com/widgetembed/?frameElementId=tvx&symbol=TVC%3AGOLD&interval=60&hidesidetoolbar=1&symboledit=1&saveimage=0&toolbarbg=fff&studies=[]&theme=dark&style=1&timezone=Etc%2FUTC&withdateranges=1&hideideas=1&hide_top_toolbar=1&hidetimescale=1" title="Gold"></iframe>
        </div>
        <div class="iframe-box">
          <iframe src="https://s.tradingview.com/widgetembed/?frameElementId=tvx&symbol=TVC%3AUSOIL&interval=60&hidesidetoolbar=1&symboledit=1&saveimage=0&toolbarbg=fff&studies=[]&theme=dark&style=1&timezone=Etc%2FUTC&withdateranges=1&hideideas=1&hide_top_toolbar=1&hidetimescale=1" title="Oil"></iframe>
        </div>
      </div>
    </section>

    <div class="footer" id="footerText">
      ساخته‌شده برای اجرا روی GitHub Pages • بدون‌سرور • به‌روزرسانی سمت‌کاربر
    </div>
  </main>

  <script>
    // ===== i18n packs =====
    const i18n = {
      fa: {
        dir:'rtl', locale:'fa-IR',
        title:'داشبور زنده بازارها', badge:'بدون‌سرور • مناسب GitHub Pages',
        cryptoTitle:'ارزهای دیجیتال', cryptoStatus:'در حال بارگذاری از CoinGecko…',
        thName:'نام', thPrice:'قیمت', thChange:'تغییر 24h', thCap:'مارکت کپ', thVol:'حجم 24h',
        forexTitle:'ارزهای جهان (Forex)', forexStatus:'در حال دریافت از Frankfurter…',
        fxPairHdr:'جفت ارز', fxRateHdr:'نرخ',
        commoditiesTitle:'طلا و کامودیتی‌ها',
        lastUpdate:'آخرین بروزرسانی', themeBtn:'تم روشن/تاریک', refreshBtn:'به‌روزرسانی',
        searchPlaceholder:'جستجو ارز…'
      },
      ar: {
        dir:'rtl', locale:'ar-SA',
        title:'لوحة الأسواق الحية', badge:'بدون خادم • مناسب لـ GitHub Pages',
        cryptoTitle:'العملات الرقمية', cryptoStatus:'جارٍ التحميل من CoinGecko…',
        thName:'الاسم', thPrice:'السعر', thChange:'تغير 24س', thCap:'القيمة السوقية', thVol:'حجم 24س',
        forexTitle:'عملات العالم (فوركس)', forexStatus:'جارٍ الجلب من Frankfurter…',
        fxPairHdr:'زوج العملة', fxRateHdr:'السعر',
        commoditiesTitle:'الذهب والسلع',
        lastUpdate:'آخر تحديث', themeBtn:'سمة فاتحة/داكنة', refreshBtn:'تحديث',
        searchPlaceholder:'ابحث عن عملة…'
      },
      en: {
        dir:'ltr', locale:'en-US',
        title:'Live markets dashboard', badge:'Serverless • Built for GitHub Pages',
        cryptoTitle:'Cryptocurrencies', cryptoStatus:'Loading from CoinGecko…',
        thName:'Name', thPrice:'Price', thChange:'24h change', thCap:'Market cap', thVol:'24h volume',
        forexTitle:'Global currencies (Forex)', forexStatus:'Fetching from Frankfurter…',
        fxPairHdr:'Pair', fxRateHdr:'Rate',
        commoditiesTitle:'Gold and commodities',
        lastUpdate:'Last update', themeBtn:'Light/Dark', refreshBtn:'Refresh',
        searchPlaceholder:'Search coin…'
      },
      ru: {
        dir:'ltr', locale:'ru-RU',
        title:'Панель живых рынков', badge:'Без сервера • Для GitHub Pages',
        cryptoTitle:'Криптовалюты', cryptoStatus:'Загрузка с CoinGecko…',
        thName:'Название', thPrice:'Цена', thChange:'Изм. 24ч', thCap:'Рыночная кап.', thVol:'Объём 24ч',
        forexTitle:'Мировые валюты (Forex)', forexStatus:'Получение с Frankfurter…',
        fxPairHdr:'Пара', fxRateHdr:'Курс',
        commoditiesTitle:'Золото и сырьё',
        lastUpdate:'Последнее обновление', themeBtn:'Светлая/Тёмная', refreshBtn:'Обновить',
        searchPlaceholder:'Поиск монеты…'
      }
    };

    // ===== State =====
    const state = {
      theme: localStorage.getItem('theme') || 'dark',
      lang: localStorage.getItem('lang') || 'fa',
      sortKey: 'market_cap',
      sortDir: 'desc',
      cryptoData: [],
      refreshMs: 60000, // 60s
      timers: []
    };
    document.body.setAttribute('data-theme', state.theme);

    // ===== Helpers =====
    function t(key){ const p=i18n[state.lang]; return p[key] || key; }
    function setText(id, val){ const el=document.getElementById(id); if(el) el.textContent=String(val); }
    function formatNum(n, opts){ try{ return Number(n).toLocaleString(i18n[state.lang].locale, opts||{}); }catch{ return n; } }
    function applyLang(){
      const p = i18n[state.lang];
      document.documentElement.dir = p.dir;
      document.documentElement.lang = state.lang;
      setText('title', p.title);
      setText('badge', p.badge);
      setText('cryptoTitle', p.cryptoTitle);
      setText('cryptoStatus', p.cryptoStatus);
      setText('thName', p.thName);
      setText('thPrice', p.thPrice);
      setText('thChange', p.thChange);
      setText('thCap', p.thCap);
      setText('thVol', p.thVol);
      setText('forexTitle', p.forexTitle);
      setText('forexStatus', p.forexStatus);
      setText('fxPairHdr', p.fxPairHdr);
      setText('fxRateHdr', p.fxRateHdr);
      setText('commoditiesTitle', p.commoditiesTitle);
      setText('footerText', p.title.includes('dashboard') ? 'Made for GitHub Pages • Serverless • Client-side updates' : 'ساخته‌شده برای اجرا روی GitHub Pages • بدون‌سرور • به‌روزرسانی سمت‌کاربر');
      document.getElementById('toggleTheme').textContent = p.themeBtn;
      document.getElementById('refreshAll').textContent = p.refreshBtn;
      document.getElementById('cryptoSearch').placeholder = p.searchPlaceholder;
      renderCrypto(); // re-render for number format
    }

    function schedule(){
      state.timers.forEach(clearInterval);
      state.timers = [];
      state.timers.push(setInterval(loadCrypto, state.refreshMs));
      state.timers.push(setInterval(loadForex, state.refreshMs));
    }

    // ===== Theme & Lang events =====
    document.getElementById('toggleTheme').addEventListener('click', ()=>{
      state.theme = state.theme === 'dark' ? 'light' : 'dark';
      document.body.setAttribute('data-theme', state.theme);
      localStorage.setItem('theme', state.theme);
    });
    const langSelect = document.getElementById('langSelect');
    langSelect.value = state.lang;
    langSelect.addEventListener('change', ()=>{
      state.lang = langSelect.value;
      localStorage.setItem('lang', state.lang);
      applyLang();
    });
    document.getElementById('refreshAll').addEventListener('click', ()=>{
      loadCrypto();
      loadForex();
    });

    // ===== Crypto: load, render, search, sort =====
    async function loadCrypto(){
      const status = document.getElementById('cryptoStatus');
      try {
        setText('cryptoStatus', t('cryptoStatus'));
        // Pull top 250 by market cap (2 pages of 125 for lighter load)
        const urls = [
          'https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=125&page=1&sparkline=false&price_change_percentage=1h,24h',
          'https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=125&page=2&sparkline=false&price_change_percentage=1h,24h'
        ];
        const results = await Promise.all(urls.map(u => fetch(u, {cache:'no-store'}).then(r=>r.json())));
        state.cryptoData = [...results[0], ...results[1]];
        renderCrypto();
        status.textContent = `${t('lastUpdate')}: ${new Date().toLocaleTimeString(i18n[state.lang].locale)}`;
      } catch (e) {
        status.textContent = state.lang==='en' ? 'Error loading crypto.' :
                             state.lang==='ru' ? 'Ошибка загрузки крипто.' :
                             state.lang==='ar' ? 'خطأ في تحميل العملات الرقمية.' :
                             'خطا در دریافت داده‌های کریپتو.';
        console.error(e);
      }
    }

    function renderCrypto(){
      const body = document.getElementById('cryptoBody');
      const q = document.getElementById('cryptoSearch').value.trim().toLowerCase();
      let rows = state.cryptoData.slice();

      // Filter
      if (q) {
        rows = rows.filter(c =>
          (c.name || '').toLowerCase().includes(q) ||
          (c.symbol || '').toLowerCase().includes(q)
        );
      }
      // Sort
      const key = state.sortKey;
      const dir = state.sortDir === 'asc' ? 1 : -1;
      rows.sort((a,b)=>{
        const va = a[key] ?? 0, vb = b[key] ?? 0;
        if (va < vb) return -1 * dir;
        if (va > vb) return 1 * dir;
        return 0;
      });

      body.innerHTML = rows.map(c=>{
        const change24 = c.price_change_percentage_24h || 0;
        const cls = change24 >= 0 ? 'delta-up' : 'delta-down';
        return `
          <tr>
            <td class="name-cell">
              <img src="${c.image}" alt="${escapeHtml(c.symbol)}">
              <span>${escapeHtml(c.name)} (${escapeHtml(c.symbol.toUpperCase())})</span>
            </td>
            <td>$${formatNum(c.current_price, {maximumFractionDigits: 6})}</td>
            <td class="${cls}">${Number(change24).toFixed(2)}%</td>
            <td>$${formatNum(c.market_cap)}</td>
            <td>$${formatNum(c.total_volume)}</td>
          </tr>
        `;
      }).join('');
    }

    // Search input
    document.getElementById('cryptoSearch').addEventListener('input', renderCrypto);

    // Sort handlers
    const ths = document.querySelectorAll('#cryptoTable thead th');
    ths.forEach(th=>{
      th.addEventListener('click', ()=>{
        const key = th.getAttribute('data-key');
        if (!key) return;
        if (state.sortKey === key) {
          state.sortDir = state.sortDir === 'asc' ? 'desc' : 'asc';
        } else {
          state.sortKey = key;
          state.sortDir = 'desc';
        }
        renderCrypto();
      });
    });

    // ===== Forex =====
    async function loadForex(){
      const status = document.getElementById('forexStatus');
      const body = document.getElementById('forexBody');
      try {
        setText('forexStatus', t('forexStatus'));
        const pairs = [['USD','EUR'], ['USD','GBP'], ['USD','JPY'], ['EUR','USD'], ['EUR','GBP']];
        const out = [];
        for (const [base, quote] of pairs) {
          const res = await fetch(`https://api.frankfurter.app/latest?from=${base}&to=${quote}`, {cache:'no-store'});
          if (!res.ok) throw new Error('Frankfurter error');
          const data = await res.json();
          const rate = data.rates[quote];
          out.push(`<tr><td>${base}/${quote}</td><td>${formatNum(rate, {maximumFractionDigits: 6})}</td></tr>`);
        }
        body.innerHTML = out.join('');
        status.textContent = `${t('lastUpdate')}: ${new Date().toLocaleTimeString(i18n[state.lang].locale)}`;
      } catch (e) {
        status.textContent = state.lang==='en' ? 'Error loading forex.' :
                             state.lang==='ru' ? 'Ошибка загрузки валют.' :
                             state.lang==='ar' ? 'خطأ في جلب العملات.' :
                             'خطا در دریافت داده‌های ارزها.';
        console.error(e);
      }
    }

    // ===== Security helpers =====
    function escapeHtml(s){
      return String(s).replace(/[&<>"'`=\/]/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'
      }[c] || c));
    }

    // ===== Init =====
    document.addEventListener('DOMContentLoaded', ()=>{
      applyLang();
      loadCrypto();
      loadForex();
      schedule();
    });
  </script>
</body>
</html>
