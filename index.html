<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>داشبور زنده بازارها</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <style>
    :root {
      --bg:#0f1115; --panel:#151823; --text:#e7edf2; --muted:#9aa7b0;
      --accent:#4cc9f0; --up:#1db954; --down:#ff3b30; --border:#222636;
      --card:#12141c; --shadow:0 8px 18px rgba(0,0,0,0.35);
    }
    [data-theme="light"] {
      --bg:#f6f7fb; --panel:#fff; --text:#1a2230; --muted:#5c6b7c;
      --accent:#1f7ae0; --up:#1ea865; --down:#c0392b; --border:#dfe4ea;
      --card:#fff; --shadow:0 8px 18px rgba(0,0,0,0.08);
    }
    body {margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Naskh Arabic",Tahoma,Arial;}
    header {background:var(--panel);padding:10px;display:flex;gap:10px;align-items:center;position:sticky;top:0;border-bottom:1px solid var(--border);}
    .card {background:var(--card);margin:10px;padding:10px;border-radius:8px;border:1px solid var(--border);}
    .status {font-size:13px;color:var(--muted);margin-top:6px;}
    .delta-up {color:var(--up);font-weight:600;}
    .delta-down {color:var(--down);font-weight:600;}
    .info-box {border:1px solid var(--border);border-radius:8px;padding:10px;background:var(--panel);margin-top:8px;}
    .grid {display:grid;gap:10px;grid-template-columns:1fr;}
    @media(min-width:760px){.grid{grid-template-columns:repeat(2,1fr);}}
    .iframe-box {border:1px solid var(--border);border-radius:8px;overflow:hidden;background:var(--panel);}
    .iframe-box iframe {width:100%;height:280px;border:0;}

    /* محدود کردن عرض فیلدها */
    .field {display:inline-block; max-width:220px;}

    /* Choices.js سفارشی */
    .choices__inner {background:var(--panel);border:1px solid var(--border);border-radius:8px;color:var(--text);padding:8px;}
    .choices__list--dropdown {background:#fff; border:1px solid var(--border); border-radius:8px; box-shadow:var(--shadow);}
    /* قالب آیتم با آیکن و متن مشکی */
    .choice-with-icon {display:flex; align-items:center; gap:8px; padding:8px 10px;}
    .choice-with-icon img {width:20px; height:20px; border-radius:50%; object-fit:contain;}
    .choice-with-icon .label {color:#000 !important; font-weight:600;}
    .choices__list--dropdown .choices__item--selectable.is-highlighted {background:var(--accent);}
    .choices__list--dropdown .choices__item--selectable.is-highlighted .label {color:#fff !important;}
    /* آیتم انتخاب‌شده در کنترل */
    .selected-with-icon {display:inline-flex; align-items:center; gap:8px;}
    .selected-with-icon img {width:18px; height:18px; border-radius:50%; object-fit:contain;}
    .selected-with-icon .label {color:var(--text); font-weight:600;}
    .choices__placeholder {color:var(--muted);}

    /* نام ارز در کارت اطلاعات */
    .coin-name {color:#ffd166; font-weight:700;}
    [data-theme="light"] .coin-name {color:#1a2230;}
  </style>
</head>
<body data-theme="dark">
<header>
  <strong id="title">داشبور زنده بازارها</strong>
  <select id="langSelect" class="field">
    <option value="fa">فارسی</option>
    <option value="ar">العربية</option>
    <option value="en">English</option>
    <option value="ru">Русский</option>
  </select>
  <button id="toggleTheme">تم روشن/تاریک</button>
  <button id="refreshAll">به‌روزرسانی</button>
</header>

<main>
  <!-- کریپتو -->
  <section class="card">
    <h3 id="cryptoTitle">کریپتو از Binance</h3>
    <label id="pairLabel" for="pairSelect">انتخاب جفت‌ارز:</label>
    <select id="pairSelect" class="field"><option value="">— هیچ‌کدام —</option></select>
    <label id="quoteLabel" for="quoteSelect">انتخاب Quote:</label>
    <select id="quoteSelect" class="field">
      <option value="USDT">USDT</option>
      <option value="BUSD">BUSD</option>
      <option value="USDC">USDC</option>
      <option value="BTC">BTC</option>
    </select>
    <div class="status" id="cryptoStatus">در حال دریافت از Binance…</div>
    <div class="info-box">
      <strong id="pairName">—</strong>
      <div id="pairPrice">قیمت: —</div>
      <div id="pairChange">تغییر 24h: —</div>
      <div id="pairVolume">حجم 24h: —</div>
      <div id="pairTrades">تعداد معاملات: —</div>
      <div class="status" id="cryptoUpdated">—</div>
    </div>
  </section>

  <!-- فارکس -->
  <section class="card">
    <h3 id="forexTitle">فارکس</h3>
    <div class="status" id="forexStatus">در حال دریافت…</div>
    <div class="info-box"><strong>USD/EUR</strong><div id="fx_usd_eur">—</div></div>
    <div class="info-box"><strong>USD/GBP</strong><div id="fx_usd_gbp">—</div></div>
    <div class="info-box"><strong>USD/JPY</strong><div id="fx_usd_jpy">—</div></div>
    <div class="info-box"><strong>EUR/GBP</strong><div id="fx_eur_gbp">—</div></div>
    <div class="status" id="forexUpdated">—</div>
  </section>

  <!-- کامودیتی‌ها -->
  <section class="card">
    <h3 id="commoditiesTitle">طلا و نفت</h3>
    <div class="grid">
      <div class="iframe-box">
        <iframe src="https://s.tradingview.com/widgetembed/?frameElementId=tvx&symbol=TVC%3AGOLD&interval=60&theme=dark&style=1" title="Gold"></iframe>
      </div>
      <div class="iframe-box">
        <iframe src="https://s.tradingview.com/widgetembed/?frameElementId=tvx&symbol=TVC%3AUSOIL&interval=60&theme=dark&style=1" title="Oil"></iframe>
      </div>
    </div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script>
  const state = { lang:'fa', quote:'USDT', binanceAll:[], pairChoices:null, quoteChoices:null };
  const i18n = {
    fa:{cryptoTitle:'کریپتو از Binance',cryptoStatus:'در حال دریافت از Binance…',pairLabel:'انتخاب جفت‌ارز:',quoteLabel:'انتخاب Quote:',priceLabel:'قیمت',changeLabel:'تغییر 24h',volLabel:'حجم 24h',tradesLabel:'تعداد معاملات',lastUpdate:'آخرین بروزرسانی',noneText:'— هیچ‌کدام —',locale:'fa-IR'},
    en:{cryptoTitle:'Crypto from Binance',cryptoStatus:'Loading from Binance…',pairLabel:'Select pair:',quoteLabel:'Select quote:',priceLabel:'Price',changeLabel:'24h change',volLabel:'24h volume',tradesLabel:'Trades',lastUpdate:'Last update',noneText:'— None —',locale:'en-US'}
  };
  function t(k){return (i18n[state.lang]||{})[k]||k;}
  function formatNum(n,opts){try{return Number(n).toLocaleString(i18n[state.lang].locale,opts||{});}catch{return n;}}

  function iconUrl(base){ return `https://cryptoicon-api.vercel.app/api/icon/${base.toLowerCase()}`; }

  async function loadBinance(){
    document.getElementById('cryptoStatus').textContent = t('cryptoStatus');
    const res = await fetch('https://api.binance.com/api/v3/ticker/24hr', {cache:'no-store'});
    state.binanceAll = await res.json();
    populatePairChoices();
    document.getElementById('cryptoUpdated').textContent = `${t('lastUpdate')}: ${new Date().toLocaleTimeString(i18n[state.lang].locale)}`;
  }

  function populatePairChoices(){
    const select = document.getElementById('pairSelect');
    const quote = state.quote;
    const pairs = state.binanceAll.filter(d => d.symbol.endsWith(quote));

    select.innerHTML = `<option value="">${t('noneText')}</option>` + pairs.map(p=>{
      const base = p.symbol.slice(0, p.symbol.length - quote.length);
      return `<option value="${p.symbol}" data-custom-properties="${iconUrl(base)}">${base}/${quote}</option>`;
    }).join('');

    if (state.pairChoices) { state.pairChoices.destroy(); }
    state.pairChoices = new Choices(select, {
      searchEnabled: true,
      itemSelectText: '',
      shouldSort: true,
      position: 'bottom',
      callbackOnCreateTemplates: function(template) {
        return {
          option: (classNames, data) => {
            const icon = data.customProperties ? `<img src="${data.customProperties}" alt="" onerror="this.style.display='none'">` : '';
            return template(`
              <div class="${classNames.item} ${classNames.itemSelectable} choice-with-icon" data-id="${data.id}" data-value="${data.value}">
                ${icon}<span class="label">${data.label}</span>
              </div>
            `);
          },
          item: (classNames, data) => {
            const icon = data.customProperties ? `<img src="${data.customProperties}" alt="" onerror="this.style.display='none'">` : '';
            return template(`
              <div class="${classNames.item} ${classNames.itemChoice} selected-with-icon" data-item data-id="${data.id}" data-value="${data.value}">
                ${icon}<span class="label">${data.label}</span>
              </div>
            `);
          }
        };
      }
    });

    select.addEventListener('change', e => renderPairInfo(e.target.value, pairs));

    select.value = '';
    select.dispatchEvent(new Event('change'));
  }

  function renderPairInfo(symbol, pairs){
    const priceEl = document.getElementById('pairPrice');
    const changeEl = document.getElementById('pairChange');
    const volEl = document.getElementById('pairVolume');
    const tradesEl = document.getElementById('pairTrades');
    const nameEl = document.getElementById('pairName');

    if (!symbol) {
      nameEl.innerHTML = '<span class="coin-name">—</span>';
      priceEl.textContent = `${t('priceLabel')}: —`;
      changeEl.textContent = `${t('changeLabel')}: —`;
      volEl.textContent = `${t('volLabel')}: —`;
      tradesEl.textContent = `${t('tradesLabel')}: —`;
      return;
    }
    const info = pairs.find(p => p.symbol === symbol);
    if (!info) return;
    const base = symbol.slice(0, symbol.length - state.quote.length);

    nameEl.innerHTML = `<span class="coin-name">${base}/${state.quote}</span>`;
    priceEl.textContent = `${t('priceLabel')}: $${formatNum(info.lastPrice, {maximumFractionDigits: 8})}`;
    changeEl.innerHTML = `${t('changeLabel')}: <span class="${Number(info.priceChangePercent)>=0?'delta-up':'delta-down'}">${formatNum(info.priceChangePercent, {maximumFractionDigits:2})}%</span>`;
    volEl.textContent = `${t('volLabel')}: $${formatNum(info.quoteVolume)}`;
    tradesEl.textContent = `${t('tradesLabel')}: ${formatNum(info.count||0)}`;
  }

  function initQuoteChoices(){
    const select = document.getElementById('quoteSelect');
    if (state.quoteChoices) { state.quoteChoices.destroy(); }
    state.quoteChoices = new Choices(select, {
      searchEnabled: false,
      itemSelectText: '',
      shouldSort: false,
      position: 'bottom'
    });
    select.addEventListener('change', ()=>{
      state.quote = select.value;
      populatePairChoices();
    });
  }

  async function loadForex(){
    document.getElementById('forexStatus').textContent = 'در حال دریافت…';
    const pairs = [
      ['USD','EUR','fx_usd_eur'],
      ['USD','GBP','fx_usd_gbp'],
      ['USD','JPY','fx_usd_jpy'],
      ['EUR','GBP','fx_eur_gbp']
    ];
    for (const [base, quote, elId] of pairs) {
      const res = await fetch(`https://api.frankfurter.app/latest?from=${base}&to=${quote}`, {cache:'no-store'});
      const data = await res.json();
      document.getElementById(elId).textContent = formatNum(data.rates[quote], {maximumFractionDigits: 6});
    }
    document.getElementById('forexUpdated').textContent = `آخرین بروزرسانی: ${new Date().toLocaleTimeString('fa-IR')}`;
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    initQuoteChoices();
    loadBinance();
    loadForex();
    document.getElementById('toggleTheme').addEventListener('click', ()=>{
      const body = document.body;
      const next = body.getAttribute('data-theme')==='dark' ? 'light' : 'dark';
      body.setAttribute('data-theme', next);
    });
    document.getElementById('refreshAll').addEventListener('click', ()=>{
      loadBinance(); loadForex();
    });
  });
</script>
</body>
</html>
