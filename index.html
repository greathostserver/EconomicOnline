<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>داشبور زنده بازارها</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <style>
    :root {
      --bg:#0f1115; --panel:#151823; --text:#e7edf2; --muted:#9aa7b0;
      --accent:#4cc9f0; --up:#1db954; --down:#ff3b30; --border:#222636;
      --card:#12141c; --field-w:220px;
    }
    body {margin:0;background:var(--bg);color:var(--text);font-family:sans-serif;}
    header {background:var(--panel);padding:10px;display:flex;gap:10px;align-items:center;position:sticky;top:0;border-bottom:1px solid var(--border);}
    .card {background:var(--card);margin:10px;padding:10px;border-radius:8px;border:1px solid var(--border);}
    .status {font-size:13px;color:var(--muted);margin-top:6px;}
    .delta-up {color:var(--up);font-weight:600;}
    .delta-down {color:var(--down);font-weight:600;}
    .info-box {border:1px solid var(--border);border-radius:10px;padding:10px;background:var(--panel);margin-top:8px;}
    .grid-2 {display:grid;gap:10px;grid-template-columns:1fr 1fr !important;} /* همیشه دو ستون */
    .field {display:inline-block;width:var(--field-w);}
    .choices {width:var(--field-w);}
    .choices__inner {background:var(--panel);border:1px solid var(--border);border-radius:10px;color:var(--text);padding:8px;}
    .choices__list--dropdown {background:#fff;border:1px solid var(--border);border-radius:10px;}
    .choice-with-icon {display:flex;align-items:center;gap:8px;padding:8px 10px;}
    .choice-with-icon img {width:20px;height:20px;border-radius:50%;object-fit:contain;}
    .choice-with-icon .label {color:#000 !important;font-weight:600;}
    .selected-with-icon {display:inline-flex;align-items:center;gap:8px;}
    .selected-with-icon img {width:18px;height:18px;border-radius:50%;object-fit:contain;}
    .selected-with-icon .label {color:var(--text);font-weight:600;}
    /* متن گزینه‌های Quote همیشه تیره */
    #quoteSelect + .choices .choices__list--dropdown .choices__item span,
    #quoteSelect + .choices .choices__list--dropdown .choice-with-icon .label {
      color:#1a2230 !important;font-weight:600;
    }
    .coin-name {color:#ffd166;font-weight:700;}
  </style>
</head>
<body data-theme="dark">
<header>
  <strong>داشبور زنده بازارها</strong>
  <select id="langSelect" class="field">
    <option value="fa">فارسی</option>
    <option value="en">English</option>
  </select>
  <button id="toggleTheme">تم روشن/تاریک</button>
  <button id="refreshAll">به‌روزرسانی</button>
</header>

<main>
  <section class="card">
    <h3>کریپتو از Binance</h3>
    <div class="grid-2">
      <div>
        <label for="quoteSelect">انتخاب Quote:</label>
        <select id="quoteSelect" class="field">
          <option value="USDT">USDT</option>
          <option value="BUSD">BUSD</option>
          <option value="USDC">USDC</option>
          <option value="BTC">BTC</option>
        </select>
      </div>
      <div>
        <label for="pairSelect">انتخاب جفت‌ارز:</label>
        <select id="pairSelect" class="field"><option value="">— هیچ‌کدام —</option></select>
      </div>
    </div>
    <div class="status" id="cryptoStatus">در حال دریافت…</div>
    <div class="info-box">
      <strong id="pairName">—</strong>
      <div id="pairPrice">قیمت: —</div>
      <div id="pairChange">تغییر 24h: —</div>
      <div id="pairVolume">حجم 24h: —</div>
      <div id="pairTrades">تعداد معاملات: —</div>
      <div class="status" id="cryptoUpdated">—</div>
    </div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script>
const state={quote:'USDT',binanceAll:[],pairChoices:null,quoteChoices:null,usdToIrr:0};
function iconUrl(base){return `https://cryptoicon-api.vercel.app/api/icon/${base.toLowerCase()}`;}
function formatNum(n,opts){try{return Number(n).toLocaleString('fa-IR',opts||{});}catch{return n;}}
  function renderPairInfo(symbol,pairs){
  const nameEl=document.getElementById('pairName');
  const priceEl=document.getElementById('pairPrice');
  const changeEl=document.getElementById('pairChange');
  const volEl=document.getElementById('pairVolume');
  const tradesEl=document.getElementById('pairTrades');

  if(!symbol){
    nameEl.innerHTML="—";
    priceEl.textContent="قیمت: —";
    changeEl.textContent="تغییر 24h: —";
    volEl.textContent="حجم 24h: —";
    tradesEl.textContent="تعداد معاملات: —";
    return;
  }
  const info=pairs.find(p=>p.symbol===symbol);
  if(!info)return;
  const base=symbol.slice(0,symbol.length-state.quote.length);
  const priceUSD=Number(info.lastPrice);
  const chgNum=Number(info.priceChangePercent);
  const volNum=Number(info.quoteVolume);
  const tradesNum=Number(info.count||0);
  const priceIRR=state.usdToIrr?priceUSD*state.usdToIrr:0;

  nameEl.innerHTML=`<span class="coin-name">${base}/${state.quote}</span>`;
  priceEl.textContent=`قیمت: $${formatNum(priceUSD)} | ریال ${formatNum(priceIRR)}`;
  changeEl.innerHTML=`تغییر 24h: <span class="${chgNum>=0?'delta-up':'delta-down'}">${formatNum(chgNum,{maximumFractionDigits:2})}%</span>`;
  volEl.textContent=`حجم 24h: $${formatNum(volNum)}`;
  tradesEl.textContent=`تعداد معاملات: ${formatNum(tradesNum)}`;
}

// تغییر تم
document.getElementById('toggleTheme').addEventListener('click',()=>{
  const body=document.body;
  body.setAttribute('data-theme',body.getAttribute('data-theme')==='dark'?'light':'dark');
});

// دکمه‌ی به‌روزرسانی
document.getElementById('refreshAll').addEventListener('click',()=>{
  loadUsdToIrr(); loadBinance();
});

// مقداردهی اولیه
document.addEventListener('DOMContentLoaded',async()=>{
  new Choices('#langSelect',{searchEnabled:false,itemSelectText:''});
  new Choices('#quoteSelect',{searchEnabled:false,itemSelectText:''});
  await loadUsdToIrr();
  await loadBinance();
  setInterval(loadUsdToIrr,5*60*1000); // هر ۵ دقیقه نرخ ریال
  setInterval(loadBinance,60*1000);    // هر دقیقه داده‌های Binance
});
</script>
</body>
</html>
